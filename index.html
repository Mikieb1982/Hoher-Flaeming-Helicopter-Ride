<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Hoher Fl√§ming Helicopter Ride</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="index.css">
    <style>
        body { margin: 0; overflow: hidden; }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="loading-helicopter">üöÅ</div>
        <div class="loading-text">Loading Hoher Fl√§ming Map...</div>
        <div class="loading-bar"><div class="loading-bar-fill"></div></div>
    </div>
    <div id="hud-container"></div>
    <div id="mobile-controls" style="display:none">
        <div id="joystick"></div>
        <div id="altitude-controls">
            <button id="alt-up">‚¨ÜÔ∏è</button>
            <span id="altitudeDisplay"></span>
            <button id="alt-down">‚¨áÔ∏è</button>
        </div>
        <button id="land-btn" style="display:none">Land</button>
    </div>
    <div id="poi-modal" class="modal" style="display:none">
        <div class="modal-content">
            <span class="close" id="poi-close">&times;</span>
            <div id="poi-title"></div>
            <div id="poi-desc"></div>
            <button id="next-poi" style="margin-top:16px;">Next &gt;</button>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/three@0.149.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.149.0/examples/js/controls/OrbitControls.js"></script>
    <script>
    // --- Constants ---
    const POIS = [
        {name:"Stadt und Burg Ziesar", x:-8027, z:-652, desc:"Historic bishop's residence."},
        {name:"Gutspark Dahlen", x:-7091, z:697, desc:"English-style park with vistas."},
        {name:"Klein Briesener Bach", x:-4892, z:-349, desc:"Protected stream area."},
        {name:"Paradies Dippmannsdorf", x:-3824, z:-1243, desc:"Nature reserve with 30+ springs."},
        {name:"T√∂pferort G√∂rzke", x:-1748, z:-1798, desc:"Traditional pottery village."},
        {name:"Hagelberg", x:-1049, z:-3178, desc:"Site of 1813 Napoleonic battle."},
        {name:"Bad Belzig mit Burg Eisenhardt", x:0, z:0, desc:"Castle with panoramic views."},
        {name:"Aussichtspunkt Belziger Landschaftswiesen", x:1682, z:1331, desc:"Bird sanctuary viewpoint."},
        {name:"Wiesenburg mit Schloss und Park", x:5002, z:-2678, desc:"Picturesque castle and park."},
        {name:"Naturparkzentrum Hoher Fl√§ming", x:4345, z:22, desc:"Nature park information center."},
        {name:"Raben mit Burg Rabenstein", x:5874, z:2698, desc:"Important border castle."},
        {name:"Niemegk", x:2142, z:4168, desc:"Historic town with local culture."},
        {name:"Fl√§mingbuchen", x:165, z:4460, desc:"Unique beech tree islands."},
        {name:"Brautrummel mit Riesenstein", x:-2455, z:3433, desc:"Periglacial valley with giant stone."},
        {name:"Neuendorfer Rummel", x:-5200, z:1745, desc:"Ice Age dry valley."},
        {name:"Garrey mit Aussichtsplattform", x:-7316, z:2473, desc:"Observation deck at old waterworks."},
    ];
    let visitedPOIs = Array(POIS.length).fill(false);
    let currentPOI = -1;

    // --- HUD ---
    function renderHUD() {
        const hud = document.getElementById('hud-container');
        if (!hud) return;
        let visited = visitedPOIs.filter(v=>v).length;
        hud.innerHTML = `
            <div class="hud-panel">
                <div>POIs: <span style="color:#ffe066">${visited}</span> / 16</div>
            </div>
            <div class="hud-panel">
                <span id="speedDisplay">SPD: 0 km/h</span>
            </div>
        `;
    }

    // --- Three.js Setup ---
    let scene, camera, renderer, helicopter, rotorGroup, mainRotor, tailRotor;
    let helicopterVelocity = new THREE.Vector3();
    let helicopterRotation = 0;
    let poiMarkers = [];
    let clock;
    let keys = {};

    function showLoading(percent) {
        let fill = document.querySelector('.loading-bar-fill');
        if (fill) fill.style.width = percent + '%';
    }

    function hideLoading() {
        let loader = document.getElementById('loading-screen');
        if (loader) loader.style.opacity = 0;
        setTimeout(()=>{if(loader) loader.style.display='none';}, 600);
    }

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xaedff2);

        camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 1, 30000);
        camera.position.set(0,150,400);

        renderer = new THREE.WebGLRenderer({antialias:true});
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // --- Lighting
        const ambient = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambient);
        const dir = new THREE.DirectionalLight(0xffffff, 0.8);
        dir.position.set(100,500,300);
        scene.add(dir);

        // --- Map ground
        const loader = new THREE.TextureLoader();
        loader.load(
            'map.jpg',
            function(texture){
                let geo = new THREE.PlaneGeometry(23000,18000);
                let mat = new THREE.MeshLambertMaterial({map:texture});
                let mesh = new THREE.Mesh(geo, mat);
                mesh.rotation.x = -Math.PI/2;
                mesh.position.y = 0;
                scene.add(mesh);
                showLoading(80);
            }
        );

        // --- POI Markers
        for(let i=0; i<POIS.length; ++i){
            let markerGeo = new THREE.SphereGeometry(70,12,12);
            let markerMat = new THREE.MeshBasicMaterial({color:0xffe066});
            let marker = new THREE.Mesh(markerGeo, markerMat);
            marker.position.set(POIS[i].x,20,POIS[i].z);
            scene.add(marker);
            poiMarkers.push(marker);
        }

        // --- Helicopter
        helicopter = new THREE.Group();
        // Body
        let bodyGeo = new THREE.CylinderGeometry(20,22,110,16);
        let bodyMat = new THREE.MeshPhongMaterial({color:0x348cdb});
        let body = new THREE.Mesh(bodyGeo, bodyMat);
        body.rotation.z = Math.PI/2;
        helicopter.add(body);
        // Cockpit
        let cockpitGeo = new THREE.SphereGeometry(23,14,12,0,Math.PI);
        let cockpitMat = new THREE.MeshPhongMaterial({color:0x99d6ea, transparent:true, opacity:0.82});
        let cockpit = new THREE.Mesh(cockpitGeo, cockpitMat);
        cockpit.position.x = 55;
        cockpit.position.y = 8;
        helicopter.add(cockpit);
        // Skids
        let skidMat = new THREE.MeshPhongMaterial({color:0x333333});
        for (let s=-1; s<=1; s+=2) {
            let skidGeo = new THREE.CylinderGeometry(2.8,2.8,58,8);
            let skid = new THREE.Mesh(skidGeo, skidMat);
            skid.position.set(-8, -22, s*18);
            skid.rotation.z = Math.PI/2;
            helicopter.add(skid);
        }
        // Rotor Group
        rotorGroup = new THREE.Group();
        // Main rotor
        let rotorGeo = new THREE.BoxGeometry(8,1,110);
        let rotorMat = new THREE.MeshPhongMaterial({color:0x222222});
        mainRotor = new THREE.Mesh(rotorGeo, rotorMat);
        mainRotor.position.y = 30;
        rotorGroup.add(mainRotor);
        // Tail boom
        let tailGeo = new THREE.CylinderGeometry(4,4,60,8);
        let tail = new THREE.Mesh(tailGeo, bodyMat);
        tail.position.x = -68;
        tail.position.y = 3;
        tail.rotation.z = Math.PI/2;
        helicopter.add(tail);

        // Tail rotor
        let tailRotorGeo = new THREE.BoxGeometry(2,20,2);
        tailRotor = new THREE.Mesh(tailRotorGeo, rotorMat);
        tailRotor.position.set(-98, 3, 0);
        tailRotor.rotation.x = Math.PI/2;
        rotorGroup.add(tailRotor);

        helicopter.add(rotorGroup);
        helicopter.position.set(0,60,0);
        scene.add(helicopter);

        // Controls
        keys = {};
        document.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
        document.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

        // Mouse drag yaw
        let mouseDown = false;
        let lastX = 0;
        document.addEventListener('mousedown', e => { mouseDown=true; lastX=e.clientX; });
        document.addEventListener('mouseup', e => { mouseDown=false; });
        document.addEventListener('mousemove', e => {
            if (!mouseDown) return;
            let dx = e.clientX - lastX;
            helicopterRotation -= dx*0.008;
            lastX = e.clientX;
        });

        // Mobile controls
        setupMobileControls();

        // Window resize
        window.addEventListener('resize', onWindowResize);

        // Initial HUD
        renderHUD();
        showLoading(90);

        clock = new THREE.Clock();

        // Hide loader
        setTimeout(hideLoading, 900);

        animate();
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    // --- Animation Loop ---
    function animate() {
        requestAnimationFrame(animate);

        let dt = Math.min(clock.getDelta(), 0.12);

        // --- Controls ---
        let inputForward = 0, inputTurn = 0, inputAltitude = 0, mobileBoost = false;
        if (isMobile) {
            // Joystick input handled separately
            inputForward = joystickVector.y;
            inputTurn = joystickVector.x;
            if (mobileAltUp) inputAltitude += 1;
            if (mobileAltDown) inputAltitude -= 1;
            mobileBoost = mobileBoostActive;
        } else {
            if (keys['arrowup'] || keys['w']) inputForward += 1;
            if (keys['arrowdown'] || keys['s']) inputForward -= 1;
            if (keys['arrowleft'] || keys['a']) inputTurn += 1;
            if (keys['arrowright'] || keys['d']) inputTurn -= 1;
            if (keys[' ']) inputAltitude += 1;
            if (keys['shift']) mobileBoost = true;
        }

        // Apply turning
        if (Math.abs(inputTurn) > 0.1) {
            helicopterRotation += inputTurn * 0.05;
        }

        // Update helicopter rotation immediately for responsive turning
        helicopter.rotation.y = helicopterRotation + Math.PI / 2;

        // Calculate movement based on helicopter's current facing direction
        const moveSpeed = (keys['shift'] || mobileBoost) ? 1.2 : 0.6;

        // Convert forward/back input to world space based on helicopter rotation
        const forwardX = Math.cos(helicopterRotation) * inputForward * moveSpeed;
        const forwardZ = Math.sin(helicopterRotation) * inputForward * moveSpeed;

        // Apply movement in the direction the helicopter is facing
        helicopterVelocity.x += forwardX;
        helicopterVelocity.z += forwardZ;

        // Apply friction
        helicopterVelocity.multiplyScalar(0.94);

        // Limit speed
        const maxSpeed = (keys['shift'] || mobileBoost) ? 8 : 4;
        if (helicopterVelocity.length() > maxSpeed) {
            helicopterVelocity.normalize().multiplyScalar(maxSpeed);
        }

        // Project velocity onto forward vector to remove sideways "slide"
        const forwardVec = new THREE.Vector3(Math.cos(helicopterRotation), 0, Math.sin(helicopterRotation));
        const speed = helicopterVelocity.dot(forwardVec); // Only keep forward component
        helicopterVelocity.copy(forwardVec.multiplyScalar(speed));

        // Update position
        helicopter.position.x += helicopterVelocity.x;
        helicopter.position.z += helicopterVelocity.z;

        // Altitude control
        if (inputAltitude !== 0) {
            const altSpeed = 2;
            helicopter.position.y += inputAltitude * altSpeed;
            helicopter.position.y = Math.max(20, Math.min(300, helicopter.position.y));
        }

        // Update altitude display for mobile
        const altDisplay = document.getElementById('altitudeDisplay');
        if (altDisplay) {
            altDisplay.textContent = `ALT: ${Math.round(helicopter.position.y)}m`;
        }

        // Boundary limits - massive map boundaries
        helicopter.position.x = Math.max(-11000, Math.min(11000, helicopter.position.x));
        helicopter.position.z = Math.max(-11000, Math.min(11000, helicopter.position.z));

        // Banking and pitch based on movement
        helicopter.rotation.z = inputTurn * 0.2; // Bank when turning
        helicopter.rotation.x = (inputForward * 0.1) - (speed * 0.02); // Pitch forward when moving

        // Rotate rotors
        rotorGroup.rotation.y += 0.4;

        // Camera follow - behind and above helicopter
        const cameraDistance = 200 + (speed * 10); // Dynamic distance based on speed
        const cameraHeight = 100 + helicopter.position.y * 0.5;

        const cameraOffset = new THREE.Vector3(
            -Math.cos(helicopterRotation) * cameraDistance,
            cameraHeight,
            -Math.sin(helicopterRotation) * cameraDistance
        );

        camera.position.lerp(helicopter.position.clone().add(cameraOffset), 0.08);
        camera.lookAt(helicopter.position);

        // Check POI proximity - larger detection radius for huge map
        poiMarkers.forEach((marker, i) => {
            const distance = helicopter.position.distanceTo(marker.position);
            if (distance < 180 && !visitedPOIs[i]) {
                marker.material.color.set(0xffffff);
                // Land prompt
                if ((keys['l'] && !isMobile) || (landBtnPressed && isMobile)) {
                    openPOIModal(i);
                }
                if (isMobile) showLandBtn(i);
            } else {
                marker.material.color.set(visitedPOIs[i] ? 0x66e66d : 0xffe066);
                if (isMobile) hideLandBtn();
            }
        });

        // HUD
        let spd = Math.abs(speed*21);
        let speedDisplay = document.getElementById('speedDisplay');
        if (speedDisplay) speedDisplay.textContent = `SPD: ${Math.round(spd)} km/h`;
        renderHUD();

        renderer.render(scene, camera);
    }

    // --- POI Modal ---
    function openPOIModal(idx) {
        if (visitedPOIs[idx]) return;
        visitedPOIs[idx] = true;
        currentPOI = idx;
        let modal = document.getElementById('poi-modal');
        if (modal) modal.style.display = 'block';
        document.getElementById('poi-title').textContent = POIS[idx].name;
        document.getElementById('poi-desc').textContent = POIS[idx].desc;
        document.getElementById('next-poi').onclick = () => {
            modal.style.display = 'none';
            // Optionally fly to next unvisited
        };
        document.getElementById('poi-close').onclick = () => {
            modal.style.display = 'none';
        };
        renderHUD();
    }

    // --- Mobile Controls ---
    let isMobile = /android|iphone|ipad|mobile/i.test(navigator.userAgent);
    let joystickVector = {x:0, y:0};
    let landBtnPressed = false;
    let mobileAltUp = false, mobileAltDown = false, mobileBoostActive = false;
    function setupMobileControls() {
        if (!isMobile) return;
        document.getElementById('mobile-controls').style.display = 'block';
        // Joystick
        const joystick = document.getElementById('joystick');
        let dragging = false, origin = {x:0,y:0};
        joystick.addEventListener('touchstart', e=>{
            dragging=true;
            let t = e.touches[0];
            origin.x = t.clientX; origin.y = t.clientY;
        });
        joystick.addEventListener('touchend', e=>{
            dragging=false;
            joystickVector.x = joystickVector.y = 0;
        });
        joystick.addEventListener('touchmove', e=>{
            if (!dragging) return;
            let t = e.touches[0];
            let dx = Math.max(-1, Math.min(1, (t.clientX-origin.x)/60));
            let dy = Math.max(-1, Math.min(1, (origin.y-t.clientY)/60));
            joystickVector.x = dx; joystickVector.y = dy;
        });
        // Altitude
        document.getElementById('alt-up').addEventListener('touchstart', ()=>mobileAltUp=true);
        document.getElementById('alt-up').addEventListener('touchend', ()=>mobileAltUp=false);
        document.getElementById('alt-down').addEventListener('touchstart', ()=>mobileAltDown=true);
        document.getElementById('alt-down').addEventListener('touchend', ()=>mobileAltDown=false);
        // Boost
        joystick.addEventListener('touchstart', ()=>mobileBoostActive=true);
        joystick.addEventListener('touchend', ()=>mobileBoostActive=false);
        // Land
        document.getElementById('land-btn').addEventListener('touchstart', ()=>landBtnPressed=true);
        document.getElementById('land-btn').addEventListener('touchend', ()=>landBtnPressed=false);
    }
    function showLandBtn(idx) {
        let btn = document.getElementById('land-btn');
        if (btn) btn.style.display = 'block';
    }
    function hideLandBtn() {
        let btn = document.getElementById('land-btn');
        if (btn) btn.style.display = 'none';
    }

    // --- Start ---
    window.onload = init;
    </script>
</body>
</html>