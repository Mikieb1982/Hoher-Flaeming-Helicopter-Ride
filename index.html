1<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Hoher Fl√§ming Helicopter Explorer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Reset and Variables --- */
        :root {
            --bg-panel: rgba(255, 255, 255, 0.9);
            --text-primary: #333333;
            --text-secondary: #666666;
            --accent-primary: #007bff;
            --accent-secondary: #dc3545;
            --accent-success: #28a745;
            --border-color: #dddddd;
            --shadow-color: rgba(0, 0, 0, 0.15);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: 'Roboto', sans-serif;
            background: #87CEEB; /* Fallback sky color */
            color: var(--text-primary);
            position: relative;
            user-select: none;
        }

        canvas {
            display: block;
        }

        /* --- Loading Screen --- */
        #loading-screen {
            position: fixed;
            inset: 0;
            background: #f0f0f0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: var(--text-primary);
            transition: opacity 0.5s ease-out, visibility 0.5s;
        }
        #loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .loading-helicopter {
            font-size: 60px;
            animation: loading-hover 1.5s ease-in-out infinite;
            margin-bottom: 20px;
        }
        @keyframes loading-hover {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .loading-text {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }
        .loading-bar {
            width: 200px;
            height: 5px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }
        .loading-bar-fill {
            height: 100%;
            background: var(--accent-primary);
            width: 0%;
            transition: width 0.5s;
        }

        /* --- HUD --- */
        #hud-container {
            position: fixed;
            top: 15px;
            left: 15px;
            right: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 200;
            pointer-events: none;
            gap: 15px;
        }
        .hud-panel {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 15px;
            box-shadow: 0 3px 8px var(--shadow-color);
            pointer-events: auto;
            flex-shrink: 0;
        }
        .hud-row { display: flex; align-items: baseline; gap: 8px; margin: 4px 0; }
        .hud-label { color: var(--text-secondary); font-size: 14px; }
        .hud-value { font-weight: bold; font-size: 16px; color: var(--text-primary); }
        
        /* --- Controls & Buttons --- */
        #controls-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            z-index: 300;
            pointer-events: none;
        }
        .action-buttons {
            display: flex;
            gap: 15px;
            align-items: center;
            pointer-events: auto;
        }
        .action-button {
            width: 60px; height: 60px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 50%;
            font-size: 24px; 
            font-weight: bold;
            color: var(--text-secondary);
            display: flex;
            justify-content: center; align-items: center; cursor: pointer;
            transition: all 0.2s ease;
        }
        .action-button:hover {
            background-color: #f8f9fa;
            border-color: #c0c0c0;
        }
        .action-button:active { transform: scale(0.95); }
        #land-button {
            background-color: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
            display: none; /* Hidden by default */
            font-size: 14px;
        }
        #land-button.visible { display: flex; }
        #land-button:hover { background-color: #0069d9; }
        
        #joystick-container {
            width: 120px;
            height: 120px;
            position: relative;
            pointer-events: auto;
        }
        #joystick-base {
            position: absolute;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            border: 2px solid rgba(0,0,0,0.1);
        }
        #joystick-handle {
            position: absolute;
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: grab;
        }

        /* --- Menu --- */
        #menu-container {
            position: fixed; top: 0; right: -350px; width: 100%; max-width: 350px; height: 100%;
            background: #f8f9fa;
            border-left: 1px solid var(--border-color);
            z-index: 400; transition: right 0.3s ease;
            display: flex; flex-direction: column;
            box-shadow: -5px 0 25px rgba(0,0,0,0.1);
        }
        #menu-container.open { right: 0; }
        #menu-header { padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        #menu-title { font-size: 20px; font-weight: bold; }
        #menu-close { background: none; border: none; font-size: 28px; color: var(--text-secondary); cursor: pointer; transition: color 0.2s, transform 0.2s; }
        #menu-close:hover { color: var(--text-primary); transform: rotate(90deg); }
        #menu-content { flex: 1; overflow-y: auto; padding: 10px; }
        #poi-list { display: flex; flex-direction: column; gap: 8px; }
        .poi-item {
            border: 1px solid transparent;
            background: white;
            border-radius: 6px; padding: 12px;
            cursor: pointer; transition: all 0.2s ease;
            display: flex; align-items: center; gap: 12px;
        }
        .poi-item:hover { border-color: var(--accent-primary); }
        .poi-item.visited { background-color: #e8f5e9; }
        .poi-item.visited .poi-item-name { text-decoration: line-through; color: var(--text-secondary); }
        .poi-item-id {
            font-size: 14px;
            font-weight: bold;
            color: var(--accent-primary);
            flex-shrink: 0;
            width: 24px;
            text-align: center;
        }
        .poi-item.visited .poi-item-id { color: var(--accent-success); }
        .poi-item-name { flex: 1; font-weight: normal; font-size: 15px; }
        .poi-item-status {
            color: var(--accent-success);
            font-size: 24px;
            font-weight: bold;
        }

        /* --- Modals --- */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 500; opacity: 0; visibility: hidden;
            transition: all 0.3s ease; backdrop-filter: blur(4px);
        }
        .modal.active { opacity: 1; visibility: visible; }
        .modal-content {
            background: white;
            padding: 30px; border-radius: 12px; width: 90%; max-width: 550px;
            box-shadow: 0 5px 20px var(--shadow-color);
            transform: scale(0.9); transition: all 0.3s ease;
        }
        .modal.active .modal-content { transform: scale(1); }
        .modal-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .modal-icon {
            width: 40px; height: 40px; background: var(--accent-primary);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 18px; font-weight: bold; color: white;
            flex-shrink: 0;
        }
        .modal.visited .modal-icon { background: var(--accent-success); }
        .modal h2 { flex: 1; margin: 0; font-size: 22px; }
        .modal-description {
            color: var(--text-secondary); line-height: 1.6; font-size: 16px;
            margin-bottom: 25px; max-height: 200px; overflow-y: auto;
        }
        .modal-buttons { display: flex; gap: 15px; justify-content: flex-end; }
        .modal-button {
            background: var(--accent-primary); color: white;
            border: none; padding: 10px 20px; border-radius: 6px;
            font-size: 15px; font-weight: bold; cursor: pointer;
            transition: all 0.2s ease;
        }
        .modal-button:hover { filter: brightness(1.1); }

        /* --- Message Toast --- */
        #message-toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.75);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 3px 8px var(--shadow-color);
            z-index: 600;
            transition: all 0.5s ease;
            opacity: 0;
            text-align: center;
        }
        #message-toast.show {
            bottom: 150px;
        }

        /* --- Responsive --- */
        @media (max-width: 768px) {
            #hud-container { flex-direction: column; align-items: stretch; }
            #message-toast.show { bottom: 160px; width: 90%; }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-helicopter">üöÅ</div>
        <div class="loading-text">Preparing Your Flight...</div>
        <div class="loading-bar"><div id="loading-bar-fill" class="loading-bar-fill"></div></div>
    </div>

    <!-- HUD -->
    <div id="hud-container" style="display: none;">
        <div class="hud-panel">
            <div class="hud-row">
                <span class="hud-label">Altitude:</span>
                <span class="hud-value" id="altitude">0m</span>
            </div>
            <div class="hud-row">
                <span class="hud-label">Speed:</span>
                <span class="hud-value" id="speed">0km/h</span>
            </div>
        </div>
        <div class="hud-panel">
            <div class="hud-row">
                <span class="hud-label">POIs Visited:</span>
                <span class="hud-value" id="visited">0/16</span>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div id="controls-container" style="display: none;">
        <div id="joystick-container">
            <div id="joystick-base"></div>
            <div id="joystick-handle"></div>
        </div>
        <div class="action-buttons">
             <button id="down-button" class="action-button">‚ñº</button>
             <button id="up-button" class="action-button">‚ñ≤</button>
             <button id="land-button" class="action-button">LAND</button>
             <button id="menu-toggle" class="action-button">‚ò∞</button>
        </div>
    </div>

    <!-- Side Menu -->
    <div id="menu-container">
        <div id="menu-header">
            <h2 id="menu-title">Points of Interest</h2>
            <button id="menu-close">&times;</button>
        </div>
        <div id="menu-content">
            <div id="poi-list"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="poi-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon"></div>
                <h2 id="info-title"></h2>
            </div>
            <p id="info-description"></p>
            <div class="modal-buttons">
                <button id="modal-close-button">Continue Flying</button>
            </div>
        </div>
    </div>

    <!-- Message Toast -->
    <div id="message-toast"></div>

    <script>
        // ============= CONFIGURATION =============
        const CONFIG = {
            MOVEMENT_SPEED: 30,
            TURN_SPEED: 1.5,
            CLIMB_SPEED: 20,
            CAMERA_DISTANCE: 30,
            CAMERA_HEIGHT: 15,
            LANDING_DISTANCE: 12,
            LANDING_HEIGHT: 8,
            MAP_SIZE: 500
        };

        // ============= POI DATA =============
        const POI_DATA = [
            { id: 1, name: "Stadt und Burg Ziesar", x: -180, z: -190, visited: false, description: "Auf der Burg Ziesar befindet sich das Museum f√ºr brandenburgische Kirchen- und Kulturgeschichte des Mittelalters. Der sehr gut erhaltene Burgfried und die Schlosskapelle bieten einen weiten Blick √ºber den Ziesarer Kiez." },
            { id: 2, name: "Gutspark Dahlen", x: -80, z: -150, visited: false, description: "Der Gutspark Dahlen ist ein Waldst√ºck seltener botanischer Kunst. Spazierg√§nge um den Schwanensee verzaubern die Besucher. Der Bauerngarten mit Kultur- und Duftpflanzen kann besucht werden." },
            { id: 3, name: "Klein Briesener Bach", x: 20, z: -170, visited: false, description: "Der Artesische Brunnen im Naturschutzgebiet Klein Briesener Bach - hier steigt das Wasser nur durch den Erd-Eigendruck hervor und wird durch eine Rinne dem Briesenflie√ü zugef√ºhrt." },
            { id: 4, name: "Paradies Dippmannsdorf", x: 140, z: -160, visited: false, description: "Aus einigen Dutzend Quellen sprudelt glasklares Wasser, das die M√ºhlenb√§che speist. Der aus Buchen, Eichen und Birken bestehende Quellkopf wurde begehbar erschlossen." },
            { id: 5, name: "T√∂pferort G√∂rzke", x: -185, z: -80, visited: false, description: "Ein Besuch der kleinen Museen und des Handwerkerhofs, ein Bummel entlang der Bauernh√∂fe und Einkaufsm√∂glichkeiten in f√ºnf T√∂pfereien erwarten die Besucher des Fl√§mingdorfes." },
            { id: 6, name: "Hagelberg", x: 15, z: -20, visited: false, description: "Der Hagelberg, ein echter 'Zweitausender' (200,3m), l√§dt zum Eintrag ins Gipfelbuch ein. F√ºr den 'Aufstieg' zum Gipfelkreuz wird man mit einem sch√∂nen Blick √ºber die Fl√§minglandschaft belohnt." },
            { id: 7, name: "Bad Belzig mit Burg Eisenhardt", x: 145, z: -50, visited: false, description: "Auf der komplett erhaltenen Burg kann die 1000-j√§hrige Geschichte der Stadt hautnah erkundet werden. Vom Butterturm bietet sich der sch√∂nste Ausblick auf Stadt und Urstromtal." },
            { id: 8, name: "Aussichtspunkt Belziger Landschaftswiesen", x: 200, z: -70, visited: false, description: "Am Burgenwanderweg gelegen, bietet sich ein eindrucksvoller Blick in das Niederungsgebiet - eines der wichtigsten Vogelschutzgebiete Brandenburgs mit Gro√ütrappen." },
            { id: 9, name: "Wiesenburg mit Schloss und Park", x: -85, z: 20, visited: false, description: "Das Schloss erhebt sich majest√§tisch √ºber dem Ort. Der als Landschaftspark gestaltete Schlosspark ist der bedeutendste seiner Art im Hohen Fl√§ming und l√§dt zum ausgiebigen Spazieren ein." },
            { id: 10, name: "Naturparkzentrum Hoher Fl√§ming", x: 40, z: 150, visited: false, description: "Das Besucherinformationszentrum ist zentrale Anlaufstelle f√ºr alle G√§ste. Hier erh√§lt man die besten Tipps f√ºr Ausfl√ºge, kann Fahrr√§der ausleihen und die Naturparkausstellung besuchen." },
            { id: 11, name: "Raben mit Burg Rabenstein", x: 30, z: 140, visited: false, description: "Auf einem H√ºgel gelegen thront die s√ºdlichste der Fl√§mingburgen, die Burg Rabenstein. Von hier f√ºhrt ein Naturlehrpfad durch das Naturschutzgebiet Rabenstein hinunter ins Dorf." },
            { id: 12, name: "Niemegk", x: 210, z: 70, visited: false, description: "Das St√§dtchen Niemegk mit seinem alten Rathaus pr√§gt das Stadtbild. Vom Kirchturm bietet sich ein sch√∂ner Ausblick auf die Hauptkette des Fl√§mings." },
            { id: 13, name: "Fl√§mingbuchen", x: -140, z: 90, visited: false, description: "In dem gro√üen Waldgebiet der Brandenheide sind einige Inseln aus Buchen zu finden, wie in den Naturschutzgebieten 'Fl√§mingbuchen' und 'Spring'." },
            { id: 14, name: "Brautrummel mit Riesenstein", x: 25, z: 35, visited: false, description: "Die Sage erz√§hlt, wie ein junges Brautpaar nach einem Gewitterregen in der Rummel ertrank. Heute kann man auf einer Rundwanderung zum Riesenstein die besondere Natur erleben." },
            { id: 15, name: "Neuendorfer Rummel", x: 150, z: 140, visited: false, description: "Die Rummeln - verzweigte, enge Trockent√§ler - entstanden nach dem Abtauen der Gletscher. Wie gr√ºne Finger stechen sie sich weit in die Agrarlandschaft hinein." },
            { id: 16, name: "Garrey mit Aussichtsplattform", x: 180, z: 160, visited: false, description: "Die Landschaft rings um Garrey bietet fantastische Ausblicke. Eine Aussichtsplattform kr√∂nt das restaurierte alte Wasserwerk, in dem sich eine kleine Ausstellung befindet." }
        ];

        // ============= GAME STATE =============
        const gameState = {
            keys: {},
            touch: {
                joystick: { x: 0, y: 0, active: false },
                up: false,
                down: false
            },
            velocity: new THREE.Vector3(),
            altitude: 10,
            speed: 0,
            visitedCount: 0,
            nearPOI: null,
            gamePaused: false,
        };

        // ============= DOM ELEMENTS =============
        const DOMElements = {
            loadingScreen: document.getElementById('loading-screen'),
            loadingBarFill: document.getElementById('loading-bar-fill'),
            hud: document.getElementById('hud-container'),
            controls: document.getElementById('controls-container'),
            altitude: document.getElementById('altitude'),
            speed: document.getElementById('speed'),
            visited: document.getElementById('visited'),
            landButton: document.getElementById('land-button'),
            upButton: document.getElementById('up-button'),
            downButton: document.getElementById('down-button'),
            menuToggle: document.getElementById('menu-toggle'),
            menuContainer: document.getElementById('menu-container'),
            menuClose: document.getElementById('menu-close'),
            poiList: document.getElementById('poi-list'),
            poiModal: document.getElementById('poi-modal'),
            modalTitle: document.getElementById('info-title'),
            modalDescription: document.getElementById('info-description'),
            modalCloseButton: document.getElementById('modal-close-button'),
            messageToast: document.getElementById('message-toast'),
            joystick: document.getElementById('joystick-container'),
            joystickHandle: document.getElementById('joystick-handle'),
        };

        // ============= SCENE SETUP =============
        const scene = new THREE.Scene();
        const FOG_COLOR = 0x87CEEB;
        scene.fog = new THREE.Fog(FOG_COLOR, 150, 450);
        
        const camera =