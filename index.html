<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Hoher Fläming Helicopter Explorer - 3D</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        :root {
            --bg-main: #f4f1e8;
            --bg-panel: rgba(255, 255, 255, 0.85);
            --text-primary: #3d352e;
            --text-secondary: #6b5f55;
            --accent-primary: #c94a4a;
            --accent-secondary: #8c7851;
            --accent-success: #5a9a68;
            --border-color: rgba(0, 0, 0, 0.1);
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
        }
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: "Georgia", "Times New Roman", serif;
            background: #000;
            color: var(--text-primary);
        }
        #game-container {
            position: absolute;
            inset: 0;
        }
        canvas {
            display: block;
        }
        .hud-container, .controls-container, .modal, .menu-container, #minimap, #achievement-toast, #loading-screen {
            position: fixed;
            z-index: 100;
        }
        #loading-screen {
            inset: 0;
            background: var(--bg-main);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: var(--text-primary);
            transition: opacity 0.5s ease-out;
        }
        .loading-helicopter { font-size: 60px; animation: loading-hover 1.5s ease-in-out infinite; margin-bottom: 20px; }
        @keyframes loading-hover {
            0%, 100% { transform: translateY(0) rotate(-2deg); }
            50% { transform: translateY(-10px) rotate(2deg); }
        }
        .loading-text { font-size: 18px; color: var(--text-secondary); margin-bottom: 20px; }
        .loading-bar { width: 200px; height: 4px; background: var(--border-color); }
        .loading-bar-fill { height: 100%; background: var(--accent-primary); width: 0%; animation: loading-progress 1.5s ease-out forwards; }
        @keyframes loading-progress { to { width: 100%; } }

        #hud-container { top: 15px; left: 15px; right: 15px; display: flex; justify-content: space-between; align-items: flex-start; pointer-events: none; }
        .hud-panel { background: var(--bg-panel); backdrop-filter: blur(5px); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px 15px; box-shadow: var(--shadow-md); pointer-events: auto; }
        .hud-row { display: flex; align-items: baseline; gap: 8px; margin: 4px 0; }
        .hud-label { color: var(--text-secondary); font-size: 14px; }
        .hud-value { font-weight: bold; font-size: 18px; color: var(--text-primary); }
        #compass { width: 50px; height: 50px; position: relative; margin-left: 15px; }
        #compass-ring { position: absolute; inset: 0; border: 2px solid var(--text-secondary); border-radius: 50%; color: var(--text-secondary); font-weight: bold; font-size: 12px; display: flex; justify-content: center; padding-top: 2px; }
        #compass-needle { position: absolute; inset: 0; transition: transform 0.1s linear; }
        #compass-needle::before { content: '▲'; position: absolute; top: -2px; left: 50%; transform: translateX(-50%); color: var(--accent-primary); font-size: 20px; }
        
        #controls-container { bottom: 20px; left: 20px; right: 20px; display: flex; justify-content: space-between; align-items: flex-end; pointer-events: none; }
        #joystick-container { width: 130px; height: 130px; position: relative; pointer-events: auto; }
        #joystick-base { position: absolute; inset: 0; background: rgba(255, 255, 255, 0.6); border: 2px solid rgba(0,0,0,0.15); border-radius: 50%; box-shadow: var(--shadow-md), inset 0 2px 4px rgba(0,0,0,0.1); }
        #joystick-handle { position: absolute; width: 60px; height: 60px; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--accent-primary); border: 2px solid rgba(255,255,255,0.5); border-radius: 50%; box-shadow: var(--shadow-sm); cursor: grab; touch-action: none; }
        #joystick-handle:active { cursor: grabbing; }
        .action-buttons { display: flex; gap: 15px; align-items: center; pointer-events: auto; }
        .action-button { width: 70px; height: 70px; background: var(--accent-primary); border: 2px solid white; border-radius: 50%; font-size: 16px; font-weight: bold; color: white; display: none; justify-content: center; align-items: center; cursor: pointer; box-shadow: var(--shadow-md); transition: all 0.2s ease; }
        .action-button.visible { display: flex; }
        .action-button:hover { transform: scale(1.05); }
        .action-button:active { transform: scale(0.95); }
        .action-button.secondary { background: var(--accent-secondary); width: 55px; height: 55px; font-size: 24px; }

        #menu-container { top: 0; right: -350px; width: 350px; height: 100%; background: var(--bg-panel); backdrop-filter: blur(10px); border-left: 1px solid var(--border-color); z-index: 400; transition: right 0.3s ease; display: flex; flex-direction: column; }
        #menu-container.open { right: 0; }
        #menu-header { padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        #menu-title { font-size: 22px; font-weight: bold; }
        #menu-close { background: none; border: none; font-size: 22px; color: var(--text-secondary); cursor: pointer; }
        #menu-content { flex: 1; overflow-y: auto; padding: 20px; }
        .menu-section { margin-bottom: 25px; }
        .menu-section-title { font-size: 14px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 10px; }
        #poi-list { display: flex; flex-direction: column; gap: 8px; }
        .poi-item { border: 1px solid var(--border-color); border-radius: 6px; padding: 10px; cursor: pointer; transition: all 0.2s ease; }
        .poi-item:hover { background: rgba(0,0,0,0.03); border-color: var(--accent-primary); }
        .poi-item.visited { background: rgba(0,0,0,0.05); text-decoration: line-through; }
        .poi-item-header { display: flex; align-items: center; gap: 10px; }
        .poi-item-name { flex: 1; font-weight: bold; font-size: 15px; }
        .poi-item-status { color: var(--accent-success); font-size: 16px; font-weight: bold; text-decoration: none; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-card { background: rgba(0,0,0,0.03); border-radius: 6px; padding: 10px; text-align: center; }
        .stat-value { font-size: 20px; font-weight: bold; }
        .stat-label { font-size: 12px; color: var(--text-secondary); }

        .modal { inset: 0; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: all 0.3s ease; backdrop-filter: blur(5px); }
        .modal.active { opacity: 1; visibility: visible; }
        .modal-content { background: var(--bg-main); border: 1px solid var(--border-color); padding: 30px; border-radius: 12px; width: 90%; max-width: 550px; box-shadow: var(--shadow-lg); transform: scale(0.9); transition: all 0.3s ease; }
        .modal.active .modal-content { transform: scale(1); }
        .modal-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .modal-icon { width: 40px; height: 40px; background: var(--accent-primary); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 18px; font-weight: bold; color: white; flex-shrink: 0; }
        .modal.visited .modal-icon { background: var(--accent-success); }
        .modal h2 { flex: 1; margin: 0; font-size: 24px; }
        .modal-description { color: var(--text-secondary); line-height: 1.7; font-size: 15px; margin-bottom: 25px; max-height: 150px; overflow-y: auto; }
        .modal-stats { display: flex; gap: 15px; margin-bottom: 25px; }
        .modal-stat { flex: 1; text-align: center; background: rgba(0,0,0,0.03); padding: 10px; border-radius: 6px; }
        .modal-stat-value { font-size: 18px; font-weight: bold; }
        .modal-stat-label { font-size: 12px; color: var(--text-secondary); }
        .modal-buttons { display: flex; gap: 15px; justify-content: flex-end; }
        .modal-button { background: var(--accent-primary); color: white; border: none; padding: 12px 25px; border-radius: 6px; font-size: 15px; font-weight: bold; cursor: pointer; }
        .modal-button:hover { filter: brightness(1.1); }
        .modal-button.secondary { background: var(--accent-secondary); }

        #achievement-toast { top: -100px; left: 50%; transform: translateX(-50%); background: var(--accent-success); color: white; padding: 12px 25px; border-radius: 50px; box-shadow: var(--shadow-md); display: flex; align-items: center; gap: 10px; transition: top 0.5s ease; }
        #achievement-toast.show { top: 20px; }
        .achievement-icon { font-size: 20px; }
        .achievement-text { font-weight: bold; }

        #minimap { bottom: 20px; right: 20px; width: 180px; height: 135px; background: rgba(255,255,255,0.7); border: 2px solid var(--border-color); border-radius: 8px; overflow: hidden; box-shadow: var(--shadow-md); }
        #minimap-canvas { width: 100%; height: 100%; }

        @media (max-width: 768px) {
            #hud-container { flex-direction: column; gap: 10px; }
            #menu-container { width: 100%; right: -100%; }
            #minimap { display: none; }
        }
    </style>
</head>
<body>
    <div id="game-container"></div>

    <div id="loading-screen">
        <div class="loading-content">
            <div class="loading-helicopter">🚁</div>
            <div class="loading-text">Building 3D World...</div>
            <div class="loading-bar"><div class="loading-bar-fill"></div></div>
        </div>
    </div>

    <div id="hud-container">
        <div class="hud-panel">
            <div class="hud-row"><span class="hud-label">Speed</span><span class="hud-value" id="speed-display">0.0</span></div>
            <div class="hud-row"><span class="hud-label">Altitude</span><span class="hud-value" id="altitude-display">0</span></div>
            <div class="hud-row"><span class="hud-label">POIs</span><span class="hud-value" id="poi-count">0/16</span></div>
            <div class="hud-row"><span class="hud-label">Time</span><span class="hud-value" id="time-display">00:00</span></div>
        </div>
        <div class="hud-panel">
            <div class="hud-row"><span class="hud-label">Heading</span><span class="hud-value" id="heading-display">0°</span></div>
            <div id="compass"><div id="compass-ring">N</div><div id="compass-needle"></div></div>
        </div>
    </div>

    <div id="controls-container">
        <div id="joystick-container"><div id="joystick-base"></div><div id="joystick-handle"></div></div>
        <div class="action-buttons">
            <button class="action-button" id="land-button">Land</button>
            <button class="action-button secondary visible" id="menu-button" title="Menu">☰</button>
        </div>
    </div>

    <div id="minimap"><canvas id="minimap-canvas"></canvas></div>

    <div id="menu-container">
        <div id="menu-header"><h2 id="menu-title">Mission Log</h2><button id="menu-close">✕</button></div>
        <div id="menu-content">
            <div class="menu-section">
                <div class="menu-section-title">Flight Statistics</div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value" id="stat-distance">0</div><div class="stat-label">Distance (km)</div></div>
                    <div class="stat-card"><div class="stat-value" id="stat-max-speed">0</div><div class="stat-label">Max Speed</div></div>
                    <div class="stat-card"><div class="stat-value" id="stat-landings">0</div><div class="stat-label">Landings</div></div>
                    <div class="stat-card"><div class="stat-value" id="stat-completion">0%</div><div class="stat-label">Completion</div></div>
                </div>
            </div>
            <div class="menu-section">
                <div class="menu-section-title">Points of Interest</div>
                <div id="poi-list"></div>
            </div>
        </div>
    </div>

    <div id="poi-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><div class="modal-icon" id="modal-icon">1</div><h2 id="poi-modal-title">POI</h2></div>
            <p class="modal-description" id="poi-modal-description"></p>
            <div class="modal-stats">
                <div class="modal-stat"><div class="modal-stat-value" id="modal-visit-time">--:--</div><div class="modal-stat-label">Visit Time</div></div>
                <div class="modal-stat"><div class="modal-stat-value" id="modal-poi-number">1/16</div><div class="modal-stat-label">Progress</div></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-button" id="continue-button">Continue</button>
                <button class="modal-button secondary" id="next-poi-button">Next POI →</button>
            </div>
        </div>
    </div>

    <div id="completion-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><div class="modal-icon">🏆</div><h2>Mission Complete!</h2></div>
            <p class="modal-description">Congratulations, pilot! You've explored all 16 points of interest.</p>
            <div class="modal-stats">
                <div class="modal-stat"><div class="modal-stat-value" id="final-time">00:00</div><div class="modal-stat-label">Total Time</div></div>
                <div class="modal-stat"><div class="modal-stat-value" id="final-distance">0 km</div><div class="stat-label">Distance</div></div>
                <div class="modal-stat"><div class="modal-stat-value" id="final-speed">0</div><div class="stat-label">Avg Speed</div></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-button" id="restart-button">New Mission</button>
                <button class="modal-button secondary" id="explore-button">Free Flight</button>
            </div>
        </div>
    </div>

    <div id="achievement-toast"><span class="achievement-icon">🏆</span><span id="achievement-text">Achievement!</span></div>

    <script type="module">
        // --- CONFIGURATION ---
        const CONFIG = {
            MAP_WIDTH: 2048,
            MAP_HEIGHT: 1448,
            MAX_SPEED: 8,
            ACCELERATION: 0.3,
            DRAG: 0.97,
            TURN_SPEED: 2.5,
            CLIMB_SPEED: 0.3,
            LANDING_RADIUS: 15,
            LANDING_ALTITUDE: 5,
            JOYSTICK_RADIUS: 55,
        };

        // --- POI DATA ---
        const POI_DATA = [
            { id: 1, name: "1. Stadt und Burg Ziesar", x: 472, y: 130, description: "Auf der Burg Ziesar befindet sich das Museum für brandenburgische Kirchen- und Kulturgeschichte des Mittelalters und der Reformationszeit. Sehenswert sind hier auch die Schlosskapelle und der sehr gut erhaltene Burgfriede - auch Schlosskappelle und der der weiße Blick vom Storchenturm über den ziesarschen Kiez." },
            { id: 2, name: "2. Gutspark Dahlen", x: 780, y: 355, description: "Der Gutspark Dahlen ist ein Waldstück seltener botanischer Wundt. Wobei die Spatziergänge um den Schwanensee die Besucher verzaubern. Zudem kann der Bauengarten Kultur- und Garttern und Duftrlanzen besucht werden. Gleich gegenüber dem Gutspark steht, etwas verborgen, die Friedhofswehrkirche." },
            { id: 3, name: "3. Klein Briesener Bach", x: 995, y: 250, description: "Der Artesische Brunnen ist im Naturschutzgebiet Klein Briesener Bach zu finden. Das Wasser steigt hier nur durch den Erd-Eigendruck hervor und wird durch eine Rinne Briesenfließ zu geführt. Wunderrode können dem Schönheiten Bach auf dem Burgerswanderweg bis zum Aussichtsturm 'Schöne Aussicht'." },
            { id: 4, name: "4. Paradies Dippmannsdorf", x: 1340, y: 275, description: "Hier scheint sich die einigen Dutzend Quellen glaskares Wasser, das die Mühlenbäche speist. Der sonstigen Buchen, Eichen und Birken bestehende Quellkopf wurde sprachlich erschlossen. Ein Spaziergang lohnt sich zu jeder Jahreszeit und lässt sich gut mit einer Wanderung auf dem Kinderferienflugplad verlieren - dem den hier auf dem Burgen-wanderweg verlauft." },
            { id: 5, name: "5. Töpferort Görzke", x: 415, y: 495, description: "Ein Besuch der kleinen Museen und des Hafischens auf dem Handwerkerhof, ein kleiner Bummel entlang der Bauernhöfe hinüber zum Städtchen Ziesar und die Einkaufsmöglichkeiten in fuuf Töpfereien können die Besucher des Flämingdorfes. Auf dem Töpferwanderweg werden Wandernde mit weit-läufigen Ausblicken auf das Tal der Buckau und die umliegende Fläminglandschaft belohnt." },
            { id: 6, name: "6. Hagelberg", x: 955, y: 725, description: "Der Hagelberg, ein echter 'Zweitausender', lädt zum Ein-stieg ins Gipfelbuch ein - nicht ohne Grund wird der Land-strich rings um Klein Glien auch 'Klein-Mittelgebirge' genannt. Für das 'Aufstieg' zum Gipfelkreuz wird mit einem Ausblick auf schönen Blick über die Fläminglandschaft belohnt. Unweit davon öffnet am Wochenende auf dem historischen Gasthof in Klein Glien ein Café für Ausflugsinnen und Ausflüger." },
            { id: 7, name: "7. Bad Belzig mit Burg Eisenhardt", x: 1364, y: 605, description: "Auf der komplett erhaltenen, die 1000-jährige Geschichte der Stadt hautnah erlunden. Vom Butterturm bietet sich wohl der schönste Ausblick auf Stadt und Urstromtal. Unterhalb der Burg befindet sich die Burgwiesen, auf denen die bedrohfreie trachten Großtrappen einen stillen Unterschlupf weckt. In der SteinTherme sorgt jodihaltiges Thermalwasser für gesunde Entspannung." },
            { id: 8, name: "8. Aussichtspunkt Belziger Landschaftswiesen", x: 1575, y: 555, description: "Am Burgenwanderweg 43 gelegen, liest sich ein besonders eindrückender Blick in das Niederungsgebiet der Belziger Land-schaftswiesen. Dort befindet sich eines der wichtigsten Vogelschutzgebiete Brandenburgs. Wenn im Winterhalbjahr Großtrappen pflichtliche Nahrung suchen, bieten sich vom Rastplatz aus sehr gute Beobachtungsmög-lichkeiten." },
            { id: 9, name: "9. Wiesenburg mit Schloss und Park", x: 765, y: 855, description: "Das Schloss erhebt sich heute über das Westende des 19. Jahrhunderts. Vom Schlossturm hat man eine ein-druckvolle Aussicht auf Wiesenburg und seinen Parkburg. Der aufstützende als Landschaftspark gestaltete Schlosspark ist der bedeutendste Aussage seiner Art im Hohen Fläming und lädt zum ausgiebigen Samsaui und Wohlritz. Bis zum Bahnhof erstrekt sich diese Anlage, durch die aus dem Kunstwanderweg führt." },
            { id: 10, name: "10. Naturparkzentrum Hoher Fläming", x: 1165, y: 1370, description: "Das Besucherinformationszentrum ist eine zentrale Anlauf-stelle für alle Gäste. Hier erhält man die besten Tipps für Ausflüge in und durch Hohen Fläming und kann Fahrräder ausleihen. Neben dem Fläming-Laden mit regionalen Produkten lädt eine spannenrde Naturparkzentrums ausstellung und einen 'Garten der Sinne'. Direkt vor dem Naturparkzentrum hält der Bus der genannten." },
            { id: 11, name: "11. Raben mit Burg Rabenstein", x: 1120, y: 1333, description: "Auf der Raben blicken 'legen' legt die süchlichste der Fläming-burgen, die Hohenburg Rabenstein. Von der Burg führt ein Friedlingspfad durch das Naturschutzgebiet Rabenstein hinunter ins Dorf und bis zum Naturparkzentrum. Die topsteller offene Feldsein-kirche kann auch besucht werden. Der Gasthof Hemmerling be-wirtet täglich außer montags seine Gäste." },
            { id: 12, name: "12. Niemegk", x: 1620, y: 1140, description: "Das Städtchen Niemegk und das alte Rathaus prägen das Stadtbild um. Vom Kirchturm bietet sich ein schöner Ausblick auf die Hauptarten des Flämings. Ein greßganter Wasserkrum, der heute ein Brausmuseum, einen Regionalladen und eine Lederungskultur behenbergs, liegen am südlichen Rand der Stadt ganz auf dem Brandwanderweg 44. Ein Ausflug mit dem Rad lohnt sich von Niemeck aus auf die Feldsteinkirchen-radroute, die zu sieben flämingstypischen Kunstensteinsten führt." },
            { id: 13, name: "13. Flämingbuchen", x: 650, y: 1174, description: "In dem großen Waldgebiet der Brandhelfe sind einige Inseln aus Buchen zu finden, wie in den Naturschutz-gebieten 'Flämingbuchen' und 'Spring'. Die Buchen-wanderwegen 70 oder 71 lassen sich diese landschaft-lichen Besonderheiten des Naturparks ertesten. Startpunkte sind die Bahnhöfe Medewitz und Merkenburg." },
            { id: 14, name: "14. Brautrummel mit Riesenstein", x: 1095, y: 995, description: "Wie ein kleiner Scetchel erfrrank im junges Brautpaar nach einem Gewitterregen in der Rummel, einem Trockental. Heute kann man auf einer Rundwanderung zum Rie-senste8n die besondere Natur in der Rummel erleben, Familienfotos auf dem Riesen-stein schleifen, ein Picknick im Grünen genießen und anschlie-ßend ein Nickerchen auf dem großen Feldbreit machen." },
            { id: 15, name: "15. Neuendorfer Rummel", x: 1400, y: 1340, description: "Die Rummeln, verzweigte, enge Trockentälchen, entstan-den nach Regien, Birnen und Weiden der Eiszeit. In Zeiten stetig weiter vereist. Wie grüne, bewaldete Finger stie-chen sie sich weit in die Agrarlandschaft hinein. Über den Burgenwanderweg oder den Rundwanderweg 40 kann man die üppig bewach-sene und stellengeise Neuen-dorfer Rummel durchwandern." },
            { id: 16, name: "16. Garrey mit Aussichtsplattform", x: 1490, y: 1430, description: "Die Landschaft rings um Garrey bietet fantastische Ausblicke, weite Täler und steile, aufgeschnittene Naturpfade. Deshalb 'krönt' eine Aussichtsplattform das alte Wasserwerk, das aufundig restauriert wurde und dem sich eine kleine Ausstellung befindet. Der Ausflug lässt sich sehr gut mit einer Wanderung in die Neuendorfer Rummel und einer Einkehr ins Café Leh-mann in Garrey verbinden." }
        ];

        // --- GAME STATE ---
        const state = {
            helicopter: {
                position: new THREE.Vector3(0, 10, 0),
                velocity: new THREE.Vector3(),
                angle: -Math.PI / 2,
                speed: 0,
                altitude: 10,
            },
            input: { keys: new Set(), joystick: { active: false, angle: 0, magnitude: 0 } },
            pois: POI_DATA.map(p => ({ ...p, visited: false, object3D: null })),
            nearbyPOI: null,
            visitedCount: 0,
            gameActive: false,
            startTime: 0,
            elapsedTime: 0,
            stats: { maxSpeed: 0, landings: 0, totalDistance: 0 },
            achievements: new Set(),
        };

        // --- DOM & 3D OBJECTS ---
        const dom = {};
        const three = {};

        // --- INITIALIZATION ---
        function init() {
            cacheDOM();
            init3D();
            initAudio();
            createPOIMarkers3D();
            populatePOIList();
            setupEventListeners();
            
            three.loadingManager.onLoad = () => {
                dom.loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    dom.loadingScreen.style.display = 'none';
                    state.gameActive = true;
                    state.startTime = Date.now();
                    requestAnimationFrame(gameLoop);
                }, 500);
            };
        }

        function cacheDOM() {
            const ids = [
                'loading-screen', 'hud-container', 'speed-display', 'altitude-display', 'poi-count', 'time-display',
                'heading-display', 'compass', 'compass-needle', 'controls-container', 'joystick-container',
                'joystick-base', 'joystick-handle', 'land-button', 'menu-button', 'menu-container',
                'menu-close', 'menu-title', 'poi-list', 'stat-distance', 'stat-max-speed', 'stat-landings',
                'stat-completion', 'poi-modal', 'modal-icon', 'poi-modal-title', 'poi-modal-description',
                'modal-visit-time', 'modal-poi-number', 'continue-button', 'next-poi-button',
                'completion-modal', 'final-time', 'final-distance', 'final-speed', 'restart-button',
                'explore-button', 'achievement-toast', 'achievement-text', 'minimap', 'minimap-canvas'
            ];
            ids.forEach(id => dom[id.replace(/-(\w)/g, (m, g) => g.toUpperCase())] = document.getElementById(id));
            dom.gameContainer = document.getElementById('game-container');
        }

        function init3D() {
            three.scene = new THREE.Scene();
            three.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 5000);
            three.renderer = new THREE.WebGLRenderer({ antialias: true });
            three.renderer.setSize(window.innerWidth, window.innerHeight);
            three.renderer.setPixelRatio(window.devicePixelRatio);
            three.renderer.shadowMap.enabled = true;
            dom.gameContainer.appendChild(three.renderer.domElement);

            three.loadingManager = new THREE.LoadingManager();
            const textureLoader = new THREE.TextureLoader(three.loadingManager);

            // Lighting
            three.scene.add(new THREE.AmbientLight(0xffffff, 0.7));
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(100, 100, 50);
            dirLight.castShadow = true;
            dirLight.shadow.mapSize.width = 2048;
            dirLight.shadow.mapSize.height = 2048;
            three.scene.add(dirLight);

            // Sky
            three.scene.background = new THREE.Color(0x87ceeb);
            three.scene.fog = new THREE.Fog(0x87ceeb, 100, 2000);

            // Terrain
            const mapTexture = textureLoader.load('images/map.jpg');
            const terrainGeometry = new THREE.PlaneGeometry(CONFIG.MAP_WIDTH, CONFIG.MAP_HEIGHT, 1, 1);
            const terrainMaterial = new THREE.MeshStandardMaterial({ map: mapTexture });
            three.terrain = new THREE.Mesh(terrainGeometry, terrainMaterial);
            three.terrain.rotation.x = -Math.PI / 2;
            three.terrain.receiveShadow = true;
            three.scene.add(three.terrain);

            // Helicopter
            createHelicopter3D();
        }
        
        function createHelicopter3D() {
            three.helicopter = new THREE.Group();
            const bodyMaterial = new THREE.MeshStandardMaterial({ color: 0xd9534f });
            
            const body = new THREE.Mesh(new THREE.BoxGeometry(2, 1, 4), bodyMaterial);
            body.position.y = 0.5;
            three.helicopter.add(body);

            const cockpit = new THREE.Mesh(new THREE.BoxGeometry(1.5, 0.5, 1), new THREE.MeshStandardMaterial({ color: 0xcccccc }));
            cockpit.position.set(0, 0.75, 1.5);
            three.helicopter.add(cockpit);

            const tail = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.2, 3), bodyMaterial);
            tail.position.set(0, 0.5, -3.5);
            three.helicopter.add(tail);

            const rotorMaterial = new THREE.MeshStandardMaterial({ color: 0x555555 });
            three.mainRotor = new THREE.Mesh(new THREE.BoxGeometry(8, 0.1, 0.2), rotorMaterial);
            three.mainRotor.position.y = 1.5;
            three.helicopter.add(three.mainRotor);

            three.helicopter.scale.set(1.5, 1.5, 1.5);
            three.helicopter.castShadow = true;
            three.scene.add(three.helicopter);
        }

        function createPOIMarkers3D() {
            const poiGeometry = new THREE.CylinderGeometry(5, 5, 2, 16);
            const beaconGeometry = new THREE.SphereGeometry(2, 8, 8);

            state.pois.forEach(poi => {
                const poiMaterial = new THREE.MeshBasicMaterial({ color: 0xc94a4a, transparent: true, opacity: 0.5 });
                const beaconMaterial = new THREE.MeshBasicMaterial({ color: 0xffdd00 });

                const group = new THREE.Group();
                const cylinder = new THREE.Mesh(poiGeometry, poiMaterial);
                const beacon = new THREE.Mesh(beaconGeometry, beaconMaterial);
                beacon.position.y = 5;
                group.add(cylinder);
                group.add(beacon);
                
                // Convert 2D map coords to 3D world coords
                const x = (poi.x / CONFIG.MAP_WIDTH - 0.5) * CONFIG.MAP_WIDTH;
                const z = (poi.y / CONFIG.MAP_HEIGHT - 0.5) * CONFIG.MAP_HEIGHT;
                group.position.set(x, 1, z);
                
                poi.object3D = group;
                three.scene.add(group);
            });
        }
        
        // --- EVENT LISTENERS & UI ---
        // (This section remains largely the same, adapted for 3D state)
        function setupEventListeners() { /* ... same as before, but calls startAudio on first interaction ... */ }
        function populatePOIList() { /* ... same as before ... */ }
        function handleKeyDown(e) { /* ... same as before ... */ }
        function handleKeyUp(e) { /* ... same as before ... */ }
        function handleJoystickStart(e) { /* ... same as before ... */ }
        // ... and so on for all UI and input functions.

        // --- GAME LOOP ---
        const clock = new THREE.Clock();
        function gameLoop() {
            const delta = clock.getDelta();
            if (state.gameActive) {
                update(delta);
            }
            render();
            requestAnimationFrame(gameLoop);
        }

        function update(dt) {
            updateHelicopter(dt);
            updateCamera();
            checkPOIProximity();
            updateAudio();
            updateStats(dt);
        }

        function updateHelicopter(dt) {
            const heli = state.helicopter;
            let thrust = 0, turning = 0, climb = 0;

            // Keyboard input
            if (state.input.keys.has('w') || state.input.keys.has('arrowup')) thrust = 1;
            if (state.input.keys.has('s') || state.input.keys.has('arrowdown')) thrust = -0.5;
            if (state.input.keys.has('a') || state.input.keys.has('arrowleft')) turning = 1;
            if (state.input.keys.has('d') || state.input.keys.has('arrowright')) turning = -1;
            if (state.input.keys.has(' ')) climb = 1;
            if (state.input.keys.has('shift')) climb = -1;

            // Joystick input
            if (state.input.joystick.active && state.input.joystick.magnitude > 0.1) {
                thrust = state.input.joystick.magnitude;
                const targetAngle = state.input.joystick.angle;
                let angleDiff = targetAngle - heli.angle;
                while (angleDiff > Math.PI) angleDiff -= Math.PI * 2;
                while (angleDiff < -Math.PI) angleDiff += Math.PI * 2;
                turning = -Math.max(-1, Math.min(1, angleDiff / (Math.PI / 4)));
            }

            heli.angle += turning * CONFIG.TURN_SPEED * dt;
            
            const accel = thrust * CONFIG.ACCELERATION;
            const forwardVector = new THREE.Vector3(0, 0, -1).applyAxisAngle(new THREE.Vector3(0, 1, 0), heli.angle);
            heli.velocity.add(forwardVector.multiplyScalar(accel * dt));

            // Vertical movement
            heli.velocity.y += climb * CONFIG.CLIMB_SPEED * dt;
            if (climb === 0 && heli.position.y > 1) { // Gravity
                 heli.velocity.y -= 0.1 * dt;
            }

            heli.velocity.multiplyScalar(Math.pow(CONFIG.DRAG, dt));
            
            heli.position.add(heli.velocity.clone().multiplyScalar(dt));

            // Ground collision
            if (heli.position.y < 1) {
                heli.position.y = 1;
                heli.velocity.y = 0;
            }
            
            // Update 3D object
            three.helicopter.position.copy(heli.position);
            three.helicopter.rotation.y = heli.angle;
            three.mainRotor.rotation.y += dt * 30 * (heli.speed / CONFIG.MAX_SPEED + 0.1);

            // Update state
            heli.speed = heli.velocity.length();
            heli.altitude = heli.position.y;
        }

        function updateCamera() {
            const offset = new THREE.Vector3(0, 8, 20);
            offset.applyAxisAngle(new THREE.Vector3(0, 1, 0), state.helicopter.angle);
            const cameraTarget = state.helicopter.position.clone().add(offset);
            three.camera.position.lerp(cameraTarget, 0.1);
            three.camera.lookAt(state.helicopter.position);
        }

        function checkPOIProximity() {
            let nearest = null;
            let minDistance = Infinity;

            state.pois.forEach(poi => {
                if (poi.visited) {
                    poi.object3D.visible = false;
                    return;
                };
                
                const distance = state.helicopter.position.distanceTo(poi.object3D.position);
                poi.object3D.children[1].material.color.set(0xffdd00); // Reset beacon color

                if (distance < minDistance) {
                    minDistance = distance;
                    nearest = poi;
                }
            });

            if (nearest && minDistance < CONFIG.LANDING_RADIUS && state.helicopter.altitude < CONFIG.LANDING_ALTITUDE) {
                state.nearbyPOI = nearest;
                dom.landButton.classList.add('visible');
                nearest.object3D.children[1].material.color.set(0x00ff00); // Highlight beacon
            } else {
                state.nearbyPOI = null;
                dom.landButton.classList.remove('visible');
            }
        }
        
        function updateStats(dt) {
            // Update total distance, etc.
        }

        function render() {
            // Update UI elements
            dom.speedDisplay.textContent = (state.helicopter.speed * 10).toFixed(1); // Scale for display
            dom.altitudeDisplay.textContent = state.helicopter.altitude.toFixed(0);
            dom.poiCount.textContent = `${state.visitedCount}/16`;
            dom.timeDisplay.textContent = formatTime(state.elapsedTime);
            const heading = (state.helicopter.angle * 180 / Math.PI) % 360;
            dom.headingDisplay.textContent = `${Math.round(heading < 0 ? 360 + heading : heading)}°`;
            dom.compassNeedle.style.transform = `rotate(${-heading}deg)`;
            
            three.renderer.render(three.scene, three.camera);
        }
        
        // --- AUDIO ---
        function initAudio() { /* ... same as before ... */ }
        function updateAudio() { /* ... same as before, based on state.helicopter.speed ... */ }

        // --- GAME ACTIONS ---
        function landAtPOI() {
            if (!state.nearbyPOI) return;
            const poi = state.nearbyPOI;
            if (!poi.visited) {
                poi.visited = true;
                state.visitedCount++;
                // ... update UI, stats, achievements
                if (state.visitedCount === 16) {
                    setTimeout(showCompletionModal, 1500);
                }
            }
            showPOIModal(poi);
        }
        
        // --- UTILITY FUNCTIONS ---
        function formatTime(ms) {
            if (ms <= 0) return '00:00';
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // --- START GAME ---
        init();
        
        // Dummy functions for UI event handlers to avoid errors
        function toggleMenu() {}
        function closeMenu() {}
        function resumeFlight() { dom.poiModal.classList.remove('active'); state.gameActive = true; }
        function navigateToNextPOI() {}
        function restartGame() { location.reload(); }
        function freeFlightMode() { dom.completionModal.classList.remove('active'); state.gameActive = true; }
        function showPOIModal(poi) {
            dom.poiModalTitle.textContent = poi.name;
            dom.poiModalDescription.textContent = poi.description;
            dom.modalIcon.textContent = String(poi.id);
            dom.modalVisitTime.textContent = formatTime(state.elapsedTime);
            dom.modalPOINumber.textContent = `${state.visitedCount}/16`;
            dom.poiModal.classList.add('active');
            state.gameActive = false;
        }
        function showCompletionModal() {
            dom.completionModal.classList.add('active');
            state.gameActive = false;
        }

    </script>
</body>
</html>
