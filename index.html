<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Hoher Fl√§ming Helicopter Explorer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Reset and Variables --- */
        :root {
            --bg-panel: rgba(255, 255, 255, 0.9);
            --text-primary: #333333;
            --text-secondary: #666666;
            --accent-primary: #007bff;
            --accent-secondary: #dc3545;
            --accent-success: #28a745;
            --border-color: #dddddd;
            --shadow-color: rgba(0, 0, 0, 0.15);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: 'Roboto', sans-serif;
            background: #87CEEB; /* Fallback sky color */
            color: var(--text-primary);
            position: relative;
            user-select: none;
        }

        canvas {
            display: block;
        }

        /* --- Loading Screen --- */
        #loading-screen {
            position: fixed;
            inset: 0;
            background: #f0f0f0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: var(--text-primary);
            transition: opacity 0.5s ease-out, visibility 0.5s;
        }
        #loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .loading-helicopter {
            font-size: 60px;
            animation: loading-hover 1.5s ease-in-out infinite;
            margin-bottom: 20px;
        }
        @keyframes loading-hover {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .loading-text {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }
        .loading-bar {
            width: 200px;
            height: 5px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }
        .loading-bar-fill {
            height: 100%;
            background: var(--accent-primary);
            width: 0%;
            transition: width 0.5s;
        }

        /* --- HUD --- */
        #hud-container {
            position: fixed;
            top: 15px;
            left: 15px;
            right: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 200;
            pointer-events: none;
            gap: 15px;
        }
        .hud-panel {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 15px;
            box-shadow: 0 3px 8px var(--shadow-color);
            pointer-events: auto;
            flex-shrink: 0;
        }
        .hud-row { display: flex; align-items: baseline; gap: 8px; margin: 4px 0; }
        .hud-label { color: var(--text-secondary); font-size: 14px; }
        .hud-value { font-weight: bold; font-size: 16px; color: var(--text-primary); }
        
        /* --- Controls & Buttons --- */
        #controls-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 300;
            pointer-events: none;
        }
        .action-buttons {
            display: flex;
            gap: 15px;
            align-items: center;
            pointer-events: auto;
            background: var(--bg-panel);
            padding: 10px;
            border-radius: 50px;
            box-shadow: 0 3px 8px var(--shadow-color);
        }
        .action-button {
            width: 60px; height: 60px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 50%;
            font-size: 14px; font-weight: bold;
            color: var(--text-secondary);
            display: flex;
            justify-content: center; align-items: center; cursor: pointer;
            transition: all 0.2s ease;
        }
        .action-button:hover {
            background-color: #f8f9fa;
            border-color: #c0c0c0;
        }
        .action-button:active { transform: scale(0.95); }
        #land-button {
            background-color: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
            display: none; /* Hidden by default */
        }
        #land-button.visible { display: flex; }
        #land-button:hover { background-color: #0069d9; }
        #menu-toggle { font-size: 24px; }
        
        /* --- Menu --- */
        #menu-container {
            position: fixed; top: 0; right: -350px; width: 100%; max-width: 350px; height: 100%;
            background: #f8f9fa;
            border-left: 1px solid var(--border-color);
            z-index: 400; transition: right 0.3s ease;
            display: flex; flex-direction: column;
            box-shadow: -5px 0 25px rgba(0,0,0,0.1);
        }
        #menu-container.open { right: 0; }
        #menu-header { padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        #menu-title { font-size: 20px; font-weight: bold; }
        #menu-close { background: none; border: none; font-size: 28px; color: var(--text-secondary); cursor: pointer; transition: color 0.2s, transform 0.2s; }
        #menu-close:hover { color: var(--text-primary); transform: rotate(90deg); }
        #menu-content { flex: 1; overflow-y: auto; padding: 10px; }
        #poi-list { display: flex; flex-direction: column; gap: 8px; }
        .poi-item {
            border: 1px solid transparent;
            background: white;
            border-radius: 6px; padding: 12px;
            cursor: pointer; transition: all 0.2s ease;
            display: flex; align-items: center; gap: 12px;
        }
        .poi-item:hover { border-color: var(--accent-primary); }
        .poi-item.visited { background-color: #e8f5e9; }
        .poi-item.visited .poi-item-name { text-decoration: line-through; color: var(--text-secondary); }
        .poi-item-id {
            font-size: 14px;
            font-weight: bold;
            color: var(--accent-primary);
            flex-shrink: 0;
            width: 24px;
            text-align: center;
        }
        .poi-item.visited .poi-item-id { color: var(--accent-success); }
        .poi-item-name { flex: 1; font-weight: normal; font-size: 15px; }
        .poi-item-status {
            color: var(--accent-success);
            font-size: 24px;
            font-weight: bold;
        }

        /* --- Modals --- */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 500; opacity: 0; visibility: hidden;
            transition: all 0.3s ease; backdrop-filter: blur(4px);
        }
        .modal.active { opacity: 1; visibility: visible; }
        .modal-content {
            background: white;
            padding: 30px; border-radius: 12px; width: 90%; max-width: 550px;
            box-shadow: 0 5px 20px var(--shadow-color);
            transform: scale(0.9); transition: all 0.3s ease;
        }
        .modal.active .modal-content { transform: scale(1); }
        .modal-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .modal-icon {
            width: 40px; height: 40px; background: var(--accent-primary);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 18px; font-weight: bold; color: white;
            flex-shrink: 0;
        }
        .modal.visited .modal-icon { background: var(--accent-success); }
        .modal h2 { flex: 1; margin: 0; font-size: 22px; }
        .modal-description {
            color: var(--text-secondary); line-height: 1.6; font-size: 16px;
            margin-bottom: 25px; max-height: 200px; overflow-y: auto;
        }
        .modal-buttons { display: flex; gap: 15px; justify-content: flex-end; }
        .modal-button {
            background: var(--accent-primary); color: white;
            border: none; padding: 10px 20px; border-radius: 6px;
            font-size: 15px; font-weight: bold; cursor: pointer;
            transition: all 0.2s ease;
        }
        .modal-button:hover { filter: brightness(1.1); }

        /* --- Message Toast --- */
        #message-toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.75);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 3px 8px var(--shadow-color);
            z-index: 600;
            transition: all 0.5s ease;
            opacity: 0;
            text-align: center;
        }
        #message-toast.show {
            bottom: 100px;
            opacity: 1;
        }

        /* --- Responsive --- */
        @media (max-width: 768px) {
            #hud-container { flex-direction: column; align-items: stretch; }
            #controls-container { left: 50%; bottom: 15px; }
            #message-toast.show { bottom: 95px; width: 90%; }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-helicopter">üöÅ</div>
        <div class="loading-text">Preparing Your Flight...</div>
        <div class="loading-bar"><div id="loading-bar-fill" class="loading-bar-fill"></div></div>
    </div>

    <!-- HUD -->
    <div id="hud-container" style="display: none;">
        <div class="hud-panel">
            <div class="hud-row">
                <span class="hud-label">Altitude:</span>
                <span class="hud-value" id="altitude">0m</span>
            </div>
            <div class="hud-row">
                <span class="hud-label">Speed:</span>
                <span class="hud-value" id="speed">0km/h</span>
            </div>
        </div>
        <div class="hud-panel">
            <div class="hud-row">
                <span class="hud-label">POIs Visited:</span>
                <span class="hud-value" id="visited">0/16</span>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div id="controls-container" style="display: none;">
        <div class="action-buttons">
             <button id="land-button" class="action-button">LAND</button>
             <button id="menu-toggle" class="action-button">‚ò∞</button>
        </div>
    </div>

    <!-- Side Menu -->
    <div id="menu-container">
        <div id="menu-header">
            <h2 id="menu-title">Points of Interest</h2>
            <button id="menu-close">&times;</button>
        </div>
        <div id="menu-content">
            <div id="poi-list"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="poi-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon"></div>
                <h2 id="info-title"></h2>
            </div>
            <p id="info-description"></p>
            <div class="modal-buttons">
                <button id="modal-close-button">Continue Flying</button>
            </div>
        </div>
    </div>

    <!-- Message Toast -->
    <div id="message-toast"></div>

    <script>
        // ============= CONFIGURATION =============
        const CONFIG = {
            MOVEMENT_SPEED: 30,
            TURN_SPEED: 1.5,
            CLIMB_SPEED: 20,
            CAMERA_DISTANCE: 30,
            CAMERA_HEIGHT: 15,
            LANDING_DISTANCE: 12,
            LANDING_HEIGHT: 8,
            MAP_SIZE: 500
        };

        // ============= POI DATA =============
        const POI_DATA = [
            { id: 1, name: "Stadt und Burg Ziesar", x: -180, z: -190, visited: false, description: "Auf der Burg Ziesar befindet sich das Museum f√ºr brandenburgische Kirchen- und Kulturgeschichte des Mittelalters. Der sehr gut erhaltene Burgfried und die Schlosskapelle bieten einen weiten Blick √ºber den Ziesarer Kiez." },
            { id: 2, name: "Gutspark Dahlen", x: -80, z: -150, visited: false, description: "Der Gutspark Dahlen ist ein Waldst√ºck seltener botanischer Kunst. Spazierg√§nge um den Schwanensee verzaubern die Besucher. Der Bauerngarten mit Kultur- und Duftpflanzen kann besucht werden." },
            { id: 3, name: "Klein Briesener Bach", x: 20, z: -170, visited: false, description: "Der Artesische Brunnen im Naturschutzgebiet Klein Briesener Bach - hier steigt das Wasser nur durch den Erd-Eigendruck hervor und wird durch eine Rinne dem Briesenflie√ü zugef√ºhrt." },
            { id: 4, name: "Paradies Dippmannsdorf", x: 140, z: -160, visited: false, description: "Aus einigen Dutzend Quellen sprudelt glasklares Wasser, das die M√ºhlenb√§che speist. Der aus Buchen, Eichen und Birken bestehende Quellkopf wurde begehbar erschlossen." },
            { id: 5, name: "T√∂pferort G√∂rzke", x: -185, z: -80, visited: false, description: "Ein Besuch der kleinen Museen und des Handwerkerhofs, ein Bummel entlang der Bauernh√∂fe und Einkaufsm√∂glichkeiten in f√ºnf T√∂pfereien erwarten die Besucher des Fl√§mingdorfes." },
            { id: 6, name: "Hagelberg", x: 15, z: -20, visited: false, description: "Der Hagelberg, ein echter 'Zweitausender' (200,3m), l√§dt zum Eintrag ins Gipfelbuch ein. F√ºr den 'Aufstieg' zum Gipfelkreuz wird man mit einem sch√∂nen Blick √ºber die Fl√§minglandschaft belohnt." },
            { id: 7, name: "Bad Belzig mit Burg Eisenhardt", x: 145, z: -50, visited: false, description: "Auf der komplett erhaltenen Burg kann die 1000-j√§hrige Geschichte der Stadt hautnah erkundet werden. Vom Butterturm bietet sich der sch√∂nste Ausblick auf Stadt und Urstromtal." },
            { id: 8, name: "Aussichtspunkt Belziger Landschaftswiesen", x: 200, z: -70, visited: false, description: "Am Burgenwanderweg gelegen, bietet sich ein eindrucksvoller Blick in das Niederungsgebiet - eines der wichtigsten Vogelschutzgebiete Brandenburgs mit Gro√ütrappen." },
            { id: 9, name: "Wiesenburg mit Schloss und Park", x: -85, z: 20, visited: false, description: "Das Schloss erhebt sich majest√§tisch √ºber dem Ort. Der als Landschaftspark gestaltete Schlosspark ist der bedeutendste seiner Art im Hohen Fl√§ming und l√§dt zum ausgiebigen Spazieren ein." },
            { id: 10, name: "Naturparkzentrum Hoher Fl√§ming", x: 40, z: 150, visited: false, description: "Das Besucherinformationszentrum ist zentrale Anlaufstelle f√ºr alle G√§ste. Hier erh√§lt man die besten Tipps f√ºr Ausfl√ºge, kann Fahrr√§der ausleihen und die Naturparkausstellung besuchen." },
            { id: 11, name: "Raben mit Burg Rabenstein", x: 30, z: 140, visited: false, description: "Auf einem H√ºgel gelegen thront die s√ºdlichste der Fl√§mingburgen, die Burg Rabenstein. Von hier f√ºhrt ein Naturlehrpfad durch das Naturschutzgebiet Rabenstein hinunter ins Dorf." },
            { id: 12, name: "Niemegk", x: 210, z: 70, visited: false, description: "Das St√§dtchen Niemegk mit seinem alten Rathaus pr√§gt das Stadtbild. Vom Kirchturm bietet sich ein sch√∂ner Ausblick auf die Hauptkette des Fl√§mings." },
            { id: 13, name: "Fl√§mingbuchen", x: -140, z: 90, visited: false, description: "In dem gro√üen Waldgebiet der Brandenheide sind einige Inseln aus Buchen zu finden, wie in den Naturschutzgebieten 'Fl√§mingbuchen' und 'Spring'." },
            { id: 14, name: "Brautrummel mit Riesenstein", x: 25, z: 35, visited: false, description: "Die Sage erz√§hlt, wie ein junges Brautpaar nach einem Gewitterregen in der Rummel ertrank. Heute kann man auf einer Rundwanderung zum Riesenstein die besondere Natur erleben." },
            { id: 15, name: "Neuendorfer Rummel", x: 150, z: 140, visited: false, description: "Die Rummeln - verzweigte, enge Trockent√§ler - entstanden nach dem Abtauen der Gletscher. Wie gr√ºne Finger stechen sie sich weit in die Agrarlandschaft hinein." },
            { id: 16, name: "Garrey mit Aussichtsplattform", x: 180, z: 160, visited: false, description: "Die Landschaft rings um Garrey bietet fantastische Ausblicke. Eine Aussichtsplattform kr√∂nt das restaurierte alte Wasserwerk, in dem sich eine kleine Ausstellung befindet." }
        ];

        // ============= GAME STATE =============
        const gameState = {
            keys: {},
            velocity: new THREE.Vector3(),
            altitude: 10,
            speed: 0,
            visitedCount: 0,
            nearPOI: null,
            gamePaused: false,
        };

        // ============= DOM ELEMENTS =============
        const DOMElements = {
            loadingScreen: document.getElementById('loading-screen'),
            loadingBarFill: document.getElementById('loading-bar-fill'),
            hud: document.getElementById('hud-container'),
            controls: document.getElementById('controls-container'),
            altitude: document.getElementById('altitude'),
            speed: document.getElementById('speed'),
            visited: document.getElementById('visited'),
            landButton: document.getElementById('land-button'),
            menuToggle: document.getElementById('menu-toggle'),
            menuContainer: document.getElementById('menu-container'),
            menuClose: document.getElementById('menu-close'),
            poiList: document.getElementById('poi-list'),
            poiModal: document.getElementById('poi-modal'),
            modalTitle: document.getElementById('info-title'),
            modalDescription: document.getElementById('info-description'),
            modalCloseButton: document.getElementById('modal-close-button'),
            messageToast: document.getElementById('message-toast'),
        };

        // ============= SCENE SETUP =============
        const scene = new THREE.Scene();
        const FOG_COLOR = 0x87CEEB;
        scene.fog = new THREE.Fog(FOG_COLOR, 200, 800);
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.outputColorSpace = THREE.SRGBColorSpace;
        document.body.appendChild(renderer.domElement);

        // ============= LIGHTING =============
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
        directionalLight.position.set(100, 100, 50);
        directionalLight.castShadow = true;
        directionalLight.shadow.mapSize.width = 2048;
        directionalLight.shadow.mapSize.height = 2048;
        directionalLight.shadow.camera.left = -300;
        directionalLight.shadow.camera.right = 300;
        directionalLight.shadow.camera.top = 300;
        directionalLight.shadow.camera.bottom = -300;
        scene.add(directionalLight);
        
        // ============= LOADERS =============
        // *** FIX: Moved loadingManager initialization before it is used ***
        const loadingManager = new THREE.LoadingManager();
        const cubeTextureLoader = new THREE.CubeTextureLoader(loadingManager);
        const textureLoader = new THREE.TextureLoader(loadingManager);


        // ============= SKYBOX =============
        const skyboxTexture = cubeTextureLoader.load([
            'https://threejs.org/examples/textures/cube/skyboxsun25deg/px.jpg',
            'https://threejs.org/examples/textures/cube/skyboxsun25deg/nx.jpg',
            'https://threejs.org/examples/textures/cube/skyboxsun25deg/py.jpg',
            'https://threejs.org/examples/textures/cube/skyboxsun25deg/ny.jpg',
            'https://threejs.org/examples/textures/cube/skyboxsun25deg/pz.jpg',
            'https://threejs.org/examples/textures/cube/skyboxsun25deg/nz.jpg',
        ]);
        scene.background = skyboxTexture;

        // ============= TERRAIN =============
        const terrainGeometry = new THREE.PlaneGeometry(CONFIG.MAP_SIZE, CONFIG.MAP_SIZE, 100, 100);
        
        const mapUrl = 'https://raw.githubusercontent.com/Mikieb1982/Hoher-Flaeming-Helicopter-Ride/main/images/map.jpg';
        
        textureLoader.load(mapUrl,
            (texture) => {
                const terrainMaterial = new THREE.MeshStandardMaterial({ map: texture, side: THREE.DoubleSide });
                const terrain = new THREE.Mesh(terrainGeometry, terrainMaterial);
                terrain.rotation.x = -Math.PI / 2;
                terrain.receiveShadow = true;
                scene.add(terrain);

                // Create the edge blur after the map loads
                createEdgeBlur();
            },
            undefined,
            (error) => {
                console.error('Map image could not be loaded.', error);
                const terrainMaterial = new THREE.MeshStandardMaterial({ color: 0x3a8b3a, side: THREE.DoubleSide });
                const terrain = new THREE.Mesh(terrainGeometry, terrainMaterial);
                terrain.rotation.x = -Math.PI / 2;
                terrain.receiveShadow = true;
                scene.add(terrain);
                createEdgeBlur();
            }
        );

        // ============= EDGE BLUR / VIGNETTE =============
        function createEdgeBlur() {
            const canvas = document.createElement('canvas');
            const size = 512;
            canvas.width = size;
            canvas.height = size;
            const context = canvas.getContext('2d');

            const centerX = size / 2;
            const centerY = size / 2;
            const innerRadius = size * 0.4; // The clear area
            const outerRadius = size / 2;

            const gradient = context.createRadialGradient(centerX, centerY, innerRadius, centerX, centerY, outerRadius);
            
            const fogColor = new THREE.Color(FOG_COLOR);
            gradient.addColorStop(0, `rgba(${fogColor.r * 255}, ${fogColor.g * 255}, ${fogColor.b * 255}, 0.0)`);
            gradient.addColorStop(1, `rgba(${fogColor.r * 255}, ${fogColor.g * 255}, ${fogColor.b * 255}, 1.0)`);

            context.fillStyle = gradient;
            context.fillRect(0, 0, size, size);

            const texture = new THREE.CanvasTexture(canvas);
            const geometry = new THREE.PlaneGeometry(CONFIG.MAP_SIZE, CONFIG.MAP_SIZE);
            const material = new THREE.MeshBasicMaterial({
                map: texture,
                transparent: true
            });

            const plane = new THREE.Mesh(geometry, material);
            plane.rotation.x = -Math.PI / 2;
            plane.position.y = 0.1; // Slightly above the map
            scene.add(plane);
        }

        // ============= HELICOPTER =============
        const helicopter = new THREE.Group();
        const bodyMaterial = new THREE.MeshStandardMaterial({ color: 0xdc3545, metalness: 0.4, roughness: 0.5 });
        const body = new THREE.Mesh(new THREE.BoxGeometry(2, 1.5, 4), bodyMaterial);
        body.position.y = 0.75;
        body.castShadow = true;
        helicopter.add(body);

        const cockpitMaterial = new THREE.MeshStandardMaterial({ color: 0xadd8e6, opacity: 0.5, transparent: true, metalness: 0.1, roughness: 0.2 });
        const cockpit = new THREE.Mesh(new THREE.SphereGeometry(1, 16, 12), cockpitMaterial);
        cockpit.position.set(0, 1, 1.5);
        cockpit.scale.set(0.9, 0.7, 1.2);
        helicopter.add(cockpit);

        const tail = new THREE.Mesh(new THREE.CylinderGeometry(0.15, 0.4, 3), bodyMaterial);
        tail.position.set(0, 0.6, -3);
        tail.rotation.x = Math.PI / 2;
        tail.castShadow = true;
        helicopter.add(tail);

        const rotorMaterial = new THREE.MeshStandardMaterial({ color: 0x666666, metalness: 0.8, roughness: 0.5 });
        const mainRotorGroup = new THREE.Group();
        const mainRotor = new THREE.Mesh(new THREE.BoxGeometry(10, 0.1, 0.4), rotorMaterial);
        mainRotorGroup.add(mainRotor);
        const mainRotor2 = mainRotor.clone();
        mainRotor2.rotation.y = Math.PI / 2;
        mainRotorGroup.add(mainRotor2);
        mainRotorGroup.position.y = 2;
        helicopter.add(mainRotorGroup);

        const tailRotorGroup = new THREE.Group();
        const tailRotor = new THREE.Mesh(new THREE.BoxGeometry(0.1, 1.5, 0.1), rotorMaterial);
        tailRotorGroup.add(tailRotor);
        tailRotorGroup.position.set(0.3, 0.6, -4.5);
        helicopter.add(tailRotorGroup);
        
        helicopter.position.set(145, 10, -50); // Start at Bad Belzig
        scene.add(helicopter);

        // ============= POI MARKERS =============
        const poiMeshes = [];
        const unvisitedFlagMaterial = new THREE.MeshStandardMaterial({ color: 0xffc107, side: THREE.DoubleSide });
        const visitedFlagMaterial = new THREE.MeshStandardMaterial({ color: 0x28a745, side: THREE.DoubleSide });

        POI_DATA.forEach(poi => {
            const group = new THREE.Group();
            
            const platform = new THREE.Mesh(
                new THREE.CylinderGeometry(5, 5, 0.5, 16),
                new THREE.MeshStandardMaterial({ color: 0xcccccc })
            );
            platform.receiveShadow = true;
            group.add(platform);

            const pole = new THREE.Mesh(
                new THREE.CylinderGeometry(0.2, 0.2, 10),
                new THREE.MeshStandardMaterial({ color: 0x666666 })
            );
            pole.position.y = 5;
            pole.castShadow = true;
            group.add(pole);

            const flag = new THREE.Mesh(new THREE.PlaneGeometry(4, 3), unvisitedFlagMaterial.clone());
            flag.position.set(2, 9, 0);
            group.add(flag);
            
            group.position.set(poi.x, 0.25, poi.z);
            group.userData = { poi: poi, flag: flag };
            scene.add(group);
            poiMeshes.push(group);
        });

        // ============= EVENT LISTENERS =============
        const setupEventListeners = () => {
            document.addEventListener('keydown', (e) => {
                if (gameState.gamePaused) return;
                const key = e.key.toLowerCase();
                if (key === 'arrowup' || key === 'w') gameState.keys['forward'] = true;
                if (key === 'arrowdown' || key === 's') gameState.keys['backward'] = true;
                if (key === 'arrowleft' || key === 'a') gameState.keys['left'] = true;
                if (key === 'arrowright' || key === 'd') gameState.keys['right'] = true;
                if (key === ' ') { gameState.keys['up'] = true; e.preventDefault(); }
                if (key === 'shift') gameState.keys['down'] = true;
                if (key === 'l') handleLanding();
            });
            document.addEventListener('keyup', (e) => {
                const key = e.key.toLowerCase();
                if (key === 'arrowup' || key === 'w') gameState.keys['forward'] = false;
                if (key === 'arrowdown' || key === 's') gameState.keys['backward'] = false;
                if (key === 'arrowleft' || key === 'a') gameState.keys['left'] = false;
                if (key === 'arrowright' || key === 'd') gameState.keys['right'] = false;
                if (key === ' ') gameState.keys['up'] = false;
                if (key === 'shift') gameState.keys['down'] = false;
            });
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            // UI Listeners
            DOMElements.landButton.addEventListener('click', handleLanding);
            DOMElements.menuToggle.addEventListener('click', () => DOMElements.menuContainer.classList.add('open'));
            DOMElements.menuClose.addEventListener('click', () => DOMElements.menuContainer.classList.remove('open'));
            DOMElements.modalCloseButton.addEventListener('click', closeInfoPanel);
        };
        
        // ============= UPDATE FUNCTIONS =============
        function updateHelicopter(delta) {
            let thrust = 0, turn = 0, climb = 0;
            if (gameState.keys['forward']) thrust = CONFIG.MOVEMENT_SPEED;
            if (gameState.keys['backward']) thrust = -CONFIG.MOVEMENT_SPEED * 0.5;
            if (gameState.keys['left']) turn = CONFIG.TURN_SPEED;
            if (gameState.keys['right']) turn = -CONFIG.TURN_SPEED;
            if (gameState.keys['up']) climb = CONFIG.CLIMB_SPEED;
            if (gameState.keys['down']) climb = -CONFIG.CLIMB_SPEED;
            
            helicopter.rotation.y += turn * delta;
            
            const forward = new THREE.Vector3(0, 0, 1);
            forward.applyQuaternion(helicopter.quaternion);
            gameState.velocity.add(forward.multiplyScalar(-thrust * delta));
            
            gameState.velocity.y += climb * delta;
            gameState.velocity.multiplyScalar(0.96); // Drag
            
            helicopter.position.add(gameState.velocity.clone().multiplyScalar(delta));
            
            if (helicopter.position.y < 1) { helicopter.position.y = 1; gameState.velocity.y = 0; }
            if (helicopter.position.y > 200) { helicopter.position.y = 200; gameState.velocity.y = 0; }
            
            const boundary = CONFIG.MAP_SIZE / 2;
            helicopter.position.x = Math.max(-boundary, Math.min(boundary, helicopter.position.x));
            helicopter.position.z = Math.max(-boundary, Math.min(boundary, helicopter.position.z));
            
            gameState.altitude = helicopter.position.y;
            gameState.speed = Math.sqrt(gameState.velocity.x ** 2 + gameState.velocity.z ** 2) * 10;
            
            helicopter.rotation.z = -turn * 0.3 - gameState.velocity.x * 0.01;
            helicopter.rotation.x = thrust * 0.01 - gameState.velocity.z * 0.01;
            
            mainRotorGroup.rotation.y += delta * 30;
            tailRotorGroup.rotation.x += delta * 40;
        }
        
        function updateCamera() {
            const offset = new THREE.Vector3(0, CONFIG.CAMERA_HEIGHT, CONFIG.CAMERA_DISTANCE);
            offset.applyQuaternion(helicopter.quaternion);
            const targetPosition = helicopter.position.clone().add(offset);
            camera.position.lerp(targetPosition, 0.1);
            camera.lookAt(helicopter.position);
        }
        
        function checkPOIs() {
            gameState.nearPOI = null;
            let closestDist = Infinity;

            poiMeshes.forEach(mesh => {
                const poi = mesh.userData.poi;
                if (poi.visited) {
                    mesh.userData.flag.material.emissive.setHex(0x000000);
                    return;
                };

                const distance = helicopter.position.distanceTo(mesh.position);
                if (distance < CONFIG.LANDING_DISTANCE && helicopter.position.y < CONFIG.LANDING_HEIGHT) {
                    if (distance < closestDist) {
                        gameState.nearPOI = poi;
                        closestDist = distance;
                    }
                }
                
                // Pulsing effect for nearby POIs
                if (distance < CONFIG.LANDING_DISTANCE * 2) {
                    const pulse = (Math.sin(Date.now() * 0.005) + 1) / 4; // 0 to 0.5
                    mesh.userData.flag.material.emissive.setHex(0xffc107);
                    mesh.userData.flag.material.emissiveIntensity = pulse;
                } else {
                    mesh.userData.flag.material.emissive.setHex(0x000000);
                }
            });
            
            DOMElements.landButton.classList.toggle('visible', !!gameState.nearPOI);
        }
        
        function handleLanding() {
            if (gameState.nearPOI) {
                const poi = gameState.nearPOI;
                poi.visited = true;
                gameState.visitedCount++;
                
                const poiMesh = poiMeshes.find(m => m.userData.poi.id === poi.id);
                if (poiMesh) {
                    poiMesh.userData.flag.material = visitedFlagMaterial.clone();
                }
                
                updatePOIList();
                showInfoPanel(poi);
                
                if (gameState.visitedCount === POI_DATA.length) {
                    setTimeout(() => showMessage("üéâ Mission Complete! All POIs discovered!"), 2000);
                }
            }
        }

        function updateHUD() {
            DOMElements.altitude.textContent = `${Math.round(gameState.altitude)}m`;
            DOMElements.speed.textContent = `${Math.round(gameState.speed)}km/h`;
            DOMElements.visited.textContent = `${gameState.visitedCount}/${POI_DATA.length}`;
        }
        
        function updatePOIList() {
            DOMElements.poiList.innerHTML = '';
            POI_DATA.forEach(poi => {
                const div = document.createElement('div');
                div.className = 'poi-item' + (poi.visited ? ' visited' : '');
                div.innerHTML = `
                    <div class="poi-item-id">${poi.id}</div>
                    <div class="poi-item-name">${poi.name}</div>
                    ${poi.visited ? '<div class="poi-item-status">‚úì</div>' : ''}
                `;
                div.onclick = () => {
                    const poiMesh = poiMeshes.find(m => m.userData.poi.id === poi.id);
                    if (poiMesh) {
                        // Gently pan camera towards the POI
                        const start = camera.position.clone();
                        const end = poiMesh.position.clone();
                        end.y = helicopter.position.y + CONFIG.CAMERA_HEIGHT; // look from a height
                        // A simple tween could be added here for smoother lookAt
                        camera.lookAt(poiMesh.position);
                        DOMElements.menuContainer.classList.remove('open');
                    }
                };
                DOMElements.poiList.appendChild(div);
            });
        }
        
        let messageTimeout;
        function showMessage(text, duration = 3000) {
            DOMElements.messageToast.textContent = text;
            DOMElements.messageToast.classList.add('show');
            clearTimeout(messageTimeout);
            if (duration > 0) {
                messageTimeout = setTimeout(() => {
                    DOMElements.messageToast.classList.remove('show');
                }, duration);
            }
        }
        
        function showInfoPanel(poi) {
            gameState.gamePaused = true;
            DOMElements.modalTitle.textContent = `${poi.id}. ${poi.name}`;
            DOMElements.modalDescription.textContent = poi.description;
            DOMElements.poiModal.classList.add('active');
            DOMElements.poiModal.classList.toggle('visited', poi.visited);
            const icon = DOMElements.poiModal.querySelector('.modal-icon');
            icon.textContent = poi.visited ? '‚úì' : poi.id;
        }
        
        function closeInfoPanel() {
            gameState.gamePaused = false;
            DOMElements.poiModal.classList.remove('active');
        }

        // ============= GAME LOOP =============
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            
            if (!gameState.gamePaused) {
                updateHelicopter(delta);
                checkPOIs();
            }
            updateCamera();
            updateHUD();
            
            renderer.render(scene, camera);
        }

        // ============= INITIALIZATION =============
        function init() {
            DOMElements.loadingScreen.classList.add('hidden');
            DOMElements.hud.style.display = 'flex';
            DOMElements.controls.style.display = 'block';
            
            updatePOIList();
            setupEventListeners();
            
            showMessage('Welcome to Hoher Fl√§ming! Use WASD/Arrows to fly.', 5000);
            
            animate();
        }

        loadingManager.onProgress = (url, itemsLoaded, itemsTotal) => {
            const progress = itemsLoaded / itemsTotal;
            DOMElements.loadingBarFill.style.width = `${progress * 100}%`;
        };
        loadingManager.onLoad = () => {
             // A small delay to ensure assets are fully ready and avoid stutter
            setTimeout(init, 500);
        };
    </script>
</body>
</html>
