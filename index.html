<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Hoher Fl√§ming Helicopter Explorer - Maptalks.js Edition</title>
    
    <!-- Maptalks and Three.js Libraries (Pinned to compatible versions) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/maptalks@1.0.0/dist/maptalks.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/maptalks@1.0.0/dist/maptalks.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/three@0.149.0/build/three.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/maptalks.three@0.17.1/dist/maptalks.three.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- Base and Map Container --- */
        html, body, #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
        }

        /* --- UI Overlay Styles --- */
        :root {
            --bg-panel: rgba(20, 20, 30, 0.85);
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --accent-primary: #00d4ff;
            --accent-secondary: #ff6b6b;
            --accent-success: #4ade80;
            --border-color: rgba(255, 255, 255, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Roboto', sans-serif;
            position: relative;
            user-select: none;
        }
        
        /* --- Loading Screen --- */
        #loading-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease-out, visibility 0.5s;
        }
        #loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .loading-helicopter {
            font-size: 80px;
            animation: loading-hover 1.5s ease-in-out infinite;
            margin-bottom: 30px;
        }
        @keyframes loading-hover {
            0%, 100% { transform: translateY(0) rotate(-5deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }
        .loading-text {
            font-size: 24px;
            color: white;
            margin-bottom: 30px;
        }
        .loading-bar {
            width: 300px;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            overflow: hidden;
        }
        .loading-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            width: 0%;
            transition: width 0.5s;
        }

        /* --- HUD --- */
        #hud-container {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%) scale(0.9);
            z-index: 200;
            pointer-events: none;
        }
        .hud-container-enter {
             animation: slideUp 0.8s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateX(-50%) scale(0.9) translateY(100%); opacity: 0; }
            to { transform: translateX(-50%) scale(0.9) translateY(0); opacity: 1; }
        }
        .instrument-panel {
            background: linear-gradient(to bottom, #2a2a2a 0%, #1a1a1a 50%, #2a2a2a 100%);
            border: 2px solid #333;
            border-radius: 8px;
            padding: 10px 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            pointer-events: auto;
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .gauge {
            width: 80px; height: 80px; background: radial-gradient(circle at 30% 30%, #3a3a3a, #1a1a1a);
            border-radius: 50%; border: 2px solid #444; position: relative;
            display: flex; align-items: center; justify-content: center;
        }
        .gauge-face {
            width: 85%; height: 85%; border-radius: 50%;
            background: radial-gradient(circle, #f4f4f4, #d0d0d0);
            position: relative; box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }
        .gauge-label {
            position: absolute; bottom: 18%; left: 50%; transform: translateX(-50%);
            font-size: 8px; font-weight: bold; color: #222; text-transform: uppercase;
            font-family: 'Courier New', monospace;
        }
        .gauge-value {
            position: absolute; top: 62%; left: 50%; transform: translateX(-50%);
            font-size: 10px; font-weight: bold; color: #222; font-family: 'Courier New', monospace;
        }
        .gauge-needle {
            position: absolute; width: 2px; height: 28px; background: #ff0000;
            left: 50%; top: 18%; transform-origin: bottom center;
            transition: transform 0.3s ease-out; z-index: 10;
        }
        .gauge-needle::after {
            content: ''; position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%);
            width: 10px; height: 10px; border-radius: 50%; background: #333;
        }
        .compass {
            width: 90px; height: 90px; background: radial-gradient(circle at 30% 30%, #3a3a3a, #1a1a1a);
            border-radius: 50%; border: 2px solid #444; position: relative;
        }
        .compass-face {
            width: 100%; height: 100%; border-radius: 50%;
            background: #1a1a1a; transition: transform 0.2s linear;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><circle cx="50" cy="50" r="48" fill="%231a1a1a" stroke="%23555" stroke-width="2"/><text x="46" y="18" font-size="12" fill="white" font-family="monospace">N</text><text x="46" y="90" font-size="12" fill="white" font-family="monospace">S</text><text x="80" y="54" font-size="12" fill="white" font-family="monospace">E</text><text x="10" y="54" font-size="12" fill="white" font-family="monospace">W</text></svg>');
            background-size: contain;
        }
        .compass::before {
            content: '‚ñ≤'; font-size: 20px; color: #ff0000;
            position: absolute; top: -2px; left: 50%; transform: translateX(-50%);
            z-index: 10;
        }
        .mission-display {
            background: #1a1a1a; border: 1px solid #333; border-radius: 4px;
            padding: 8px 12px; display: flex; flex-direction: column; gap: 6px;
        }
        .mission-display-screen {
            font-family: 'Courier New', monospace; color: #0f0; font-size: 10px;
            text-shadow: 0 0 2px #0f0;
        }
        .mission-label { color: #777; font-size: 8px; text-transform: uppercase; }
        .mission-value { color: #0f0; font-weight: bold; }

        /* --- Controls & UI Elements --- */
        #controls-container {
            position: fixed; bottom: 30px; left: 30px; right: 30px;
            display: flex; justify-content: space-between; align-items: flex-end;
            z-index: 300; pointer-events: none;
        }
        .action-buttons { display: flex; gap: 20px; pointer-events: auto; }
        .action-button {
            width: 70px; height: 70px; background: var(--bg-panel);
            backdrop-filter: blur(10px); border: 2px solid var(--border-color);
            border-radius: 50%; font-size: 28px; color: var(--accent-primary);
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            transition: all 0.3s ease; box-shadow: 0 4px 20px var(--shadow-color);
        }
        .action-button:hover { transform: scale(1.1); border-color: var(--accent-primary); }
        #land-button { display: none; font-size: 16px; }
        #land-button.visible { display: flex; }
        #joystick-container { width: 150px; height: 150px; position: relative; pointer-events: auto; }
        #joystick-base {
            position: absolute; width: 100%; height: 100%; background: var(--bg-panel);
            backdrop-filter: blur(10px); border-radius: 50%; border: 2px solid var(--border-color);
        }
        #joystick-handle {
            position: absolute; width: 70px; height: 70px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%);
            cursor: grab;
        }
        #menu-container {
            position: fixed; z-index: 400;
            top: 0; right: -400px; width: 100%; max-width: 400px; height: 100%; 
            background: rgba(20,20,30,0.98); backdrop-filter: blur(20px); 
            border-left: 1px solid var(--border-color); transition: right 0.4s;
        }
        #menu-container.open { right: 0; }
        #menu-header { padding: 25px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        #menu-title { font-size: 24px; font-weight: bold; }
        #menu-close { background: none; border: none; font-size: 32px; color: var(--text-secondary); cursor: pointer; }
        #menu-content { flex: 1; overflow-y: auto; padding: 20px; }
        #poi-list { display: flex; flex-direction: column; gap: 12px; }
        .poi-item { background: rgba(255,255,255,0.05); border-radius: 10px; padding: 15px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 15px; }
        .poi-item:hover { border-color: var(--accent-primary); background: rgba(255,255,255,0.1); }
        .poi-item.visited { background: rgba(74,222,128,0.1); }
        .poi-item-id { font-size: 16px; font-weight: bold; color: var(--accent-primary); }
        .poi-item-name { flex: 1; font-size: 16px; }
        .poi-item-distance { font-size: 12px; color: var(--text-secondary); }

    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- UI Overlays -->
    <div id="loading-screen">
        <div class="loading-helicopter">üöÅ</div>
        <div class="loading-text">Loading Map & 3D Models...</div>
        <div class="loading-bar"><div id="loading-bar-fill"></div></div>
    </div>

    <div id="hud-container" style="display: none;">
        <div class="instrument-panel">
            <div class="gauge altimeter"><div class="gauge-face"><div class="gauge-needle" id="altitude-needle"></div><div class="gauge-label">ALT</div><div class="gauge-value" id="altitude">0m</div></div></div>
            <div class="gauge speed-indicator"><div class="gauge-face"><div class="gauge-needle" id="speed-needle"></div><div class="gauge-label">SPEED</div><div class="gauge-value" id="speed">0km/h</div></div></div>
            <div class="compass"><div class="compass-face" id="compass-face"></div></div>
            <div class="gauge fuel-gauge"><div class="gauge-face"><div class="gauge-needle" id="fuel-needle"></div><div class="gauge-label">FUEL</div><div class="gauge-value" id="fuel">100%</div></div></div>
            <div class="mission-display"><div class="mission-display-screen"><div class="mission-label">MISSION</div><div>POI: <span class="mission-value" id="visited">0/16</span></div><div>TIME: <span class="mission-value" id="flight-time">00:00</span></div></div></div>
        </div>
    </div>

    <div id="controls-container" style="display: none;">
        <div id="joystick-container"><div id="joystick-base"></div><div id="joystick-handle"></div></div>
        <div class="action-buttons">
             <button id="down-button" class="action-button">‚ñº</button>
             <button id="up-button" class="action-button">‚ñ≤</button>
             <button id="land-button" class="action-button">LAND</button>
             <button id="menu-toggle" class="action-button">‚ò∞</button>
        </div>
    </div>

    <div id="menu-container">
        <div id="menu-header"><h2 id="menu-title">Points of Interest</h2><button id="menu-close">&times;</button></div>
        <div id="menu-content"><div id="poi-list"></div></div>
    </div>
    
    <script>
        // ============= API KEY =============
        const MAPTILER_KEY = 'YOUR_MAPTILER_API_KEY'; // <-- PASTE YOUR KEY HERE

        // ============= CONFIGURATION =============
        const CONFIG = {
            START_LOCATION: [12.59, 52.14], // Bad Belzig
            MOVEMENT_SPEED: 0.0003, // In degrees per second
            TURN_SPEED: 1.5,      // In radians per second
            CLIMB_SPEED: 40,      // In meters per second
            LANDING_DISTANCE: 50, // meters
            LANDING_HEIGHT: 20,   // meters above POI
        };

        // ============= POI DATA =============
        const POI_DATA = [
            { id: 1, name: "Stadt und Burg Ziesar", lon: 12.28, lat: 52.26, visited: false, description: "Auf der Burg Ziesar befindet sich das Museum f√ºr brandenburgische Kirchen- und Kulturgeschichte des Mittelalters..." },
            { id: 7, name: "Bad Belzig mit Burg Eisenhardt", lon: 12.59, lat: 52.14, visited: false, description: "Auf der komplett erhaltenen Burg kann die 1000-j√§hrige Geschichte der Stadt hautnah erkundet werden...", isFuelStation: true },
            { id: 9, name: "Wiesenburg mit Schloss und Park", lon: 12.45, lat: 52.11, visited: false, description: "Das Schloss erhebt sich majest√§tisch √ºber dem Ort..." },
            { id: 11, name: "Raben mit Burg Rabenstein", lon: 12.56, lat: 52.04, visited: false, description: "Auf einem H√ºgel gelegen thront die s√ºdlichste der Fl√§mingburgen..." },
        ];

        // ============= GAME STATE =============
        const gameState = {
            keys: {},
            touch: { joystick: { x: 0, y: 0, active: false }, up: false, down: false },
            heading: 0, // radians
            altitude: 200, // meters
            speed: 0,
            gamePaused: false,
        };

        // ============= DOM ELEMENTS =============
        const DOMElements = {
            loadingScreen: document.getElementById('loading-screen'),
            hud: document.getElementById('hud-container'),
            controls: document.getElementById('controls-container'),
            altitude: document.getElementById('altitude'),
            speed: document.getElementById('speed'),
            compassFace: document.getElementById('compass-face'),
        };

        // ============= MAPTALKS SETUP =============
        const map = new maptalks.Map('map', {
            center: CONFIG.START_LOCATION,
            zoom: 13,
            pitch: 60,
            bearing: 0,
            centerCross: false,
            baseLayer: new maptalks.TileLayer('base', {
                urlTemplate: `https://api.maptiler.com/maps/satellite/{z}/{x}/{y}.jpg?key=${MAPTILER_KEY}`,
                subdomains: ['a', 'b', 'c', 'd'],
                attribution: '&copy; <a href="https://www.maptiler.com/">MapTiler</a> &copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            }),
            terrain: {
                urlTemplate: `https://api.maptiler.com/tiles/terrain-rgb/{z}/{x}/{y}.png?key=${MAPTILER_KEY}`,
                exaggeration: 1.5
            }
        });

        // ============= THREE.JS LAYER SETUP =============
        const threeLayer = new maptalks.ThreeLayer('three', {
            forceRenderOnMoving: true,
            forceRenderOnZooming: true,
            forceRenderOnRotating: true,
            animation: true
        });

        let helicopter; // This will hold our BaseObject for the helicopter

        threeLayer.prepareToDraw = function (gl, scene, camera) {
            const light = new THREE.DirectionalLight(0xffffff, 1.0);
            light.position.set(0, -1, 1).normalize();
            scene.add(light);
            scene.add(new THREE.AmbientLight(0xffffff, 0.8));

            // Create the helicopter model
            const helicopterModel = createHelicopterModel();
            // **FIX**: The correct way to create a BaseObject is with maptalks.THREE (all caps)
            helicopter = new maptalks.THREE.BaseObject(helicopterModel, {
                coordinate: CONFIG.START_LOCATION,
                altitude: gameState.altitude
            });
            threeLayer.add(helicopter);

            // Create POI markers
            POI_DATA.forEach(poi => {
                const poiModel = createPOIMarker();
                // **FIX**: Create a BaseObject for each POI and add it
                const poiBaseObject = new maptalks.THREE.BaseObject(poiModel, {
                    coordinate: [poi.lon, poi.lat]
                });
                threeLayer.add(poiBaseObject);
            });
            
            // Start the animation loop after the scene is fully prepared
            startAnimation();
        };
        
        threeLayer.addTo(map);

        // ============= 3D MODEL CREATION =============
        function createHelicopterModel() {
            const group = new THREE.Group();
            const bodyMaterial = new THREE.MeshStandardMaterial({ color: 0xdc3545, metalness: 0.4, roughness: 0.5 });
            const body = new THREE.Mesh(new THREE.BoxGeometry(2, 1.5, 4), bodyMaterial);
            group.add(body);
            // You can add more parts like cockpit, tail, rotors here
            return group;
        }

        function createPOIMarker() {
            const material = new THREE.MeshBasicMaterial({ color: 0xffe85e, transparent: true });
            const geometry = new THREE.CylinderGeometry(8, 8, 80, 6);
            const marker = new THREE.Mesh(geometry, material);
            marker.rotation.x = Math.PI / 2; // Orient the cylinder to stand up
            return marker;
        }

        // ============= EVENT LISTENERS =============
        document.addEventListener('keydown', (e) => { gameState.keys[e.key.toLowerCase()] = true; });
        document.addEventListener('keyup', (e) => { gameState.keys[e.key.toLowerCase()] = false; });
        // Add joystick and other UI listeners here...
        
        // ============= GAME LOOP =============
        let lastTime = 0;
        function startAnimation() {
            // This function is called from prepareToDraw, ensuring everything is loaded.
            DOMElements.loadingScreen.classList.add('hidden');
            DOMElements.hud.style.display = 'flex';
            DOMElements.hud.classList.add('hud-container-enter');
            DOMElements.controls.style.display = 'flex';
            lastTime = performance.now();
            animate();
        }

        function animate() {
            // Use performance.now() for a more stable delta time
            const now = performance.now();
            const delta = (now - lastTime) / 1000.0;
            lastTime = now;

            // Add a check to prevent large jumps in time if the tab is inactive
            if (gameState.gamePaused || !helicopter || isNaN(delta) || delta > 0.5) {
                requestAnimationFrame(animate);
                return;
            }

            // --- Get Input ---
            let thrustInput = 0, turnInput = 0, climbInput = 0;
            if (gameState.keys['w'] || gameState.keys['arrowup']) thrustInput = 1;
            if (gameState.keys['s'] || gameState.keys['arrowdown']) thrustInput = -0.5;
            if (gameState.keys['a'] || gameState.keys['arrowleft']) turnInput = 1;
            if (gameState.keys['d'] || gameState.keys['arrowright']) turnInput = -1;
            if (gameState.keys[' ']) climbInput = 1;
            if (gameState.keys['shift']) climbInput = -1;

            // --- Update Helicopter Physics ---
            gameState.heading += turnInput * CONFIG.TURN_SPEED * delta;
            
            const currentCoord = helicopter.getCoordinates();
            const newLon = currentCoord.x + Math.sin(gameState.heading) * CONFIG.MOVEMENT_SPEED * thrustInput * delta;
            const newLat = currentCoord.y + Math.cos(gameState.heading) * CONFIG.MOVEMENT_SPEED * thrustInput * delta;
            
            gameState.altitude += climbInput * CONFIG.CLIMB_SPEED * delta;
            
            const terrainAltitude = map.getAltitude(currentCoord) || 0;
            if (gameState.altitude < terrainAltitude + 10) {
                gameState.altitude = terrainAltitude + 10;
            }

            // --- Update 3D Model and Map ---
            const newCoordinate = new maptalks.Coordinate(newLon, newLat);
            helicopter.setCoordinates(newCoordinate);
            helicopter.setAltitude(gameState.altitude);
            helicopter.setRotation(0, 0, -gameState.heading);

            // --- Update Camera ---
            map.setCenter(newCoordinate);
            map.setBearing(180 * gameState.heading / Math.PI);

            // --- Update Game State & HUD ---
            gameState.speed = Math.abs(thrustInput * 180); // Simplified speed calculation
            updateHUD();
            
            requestAnimationFrame(animate);
        }

        function updateHUD() {
            DOMElements.altitude.textContent = `${Math.round(gameState.altitude)}m`;
            DOMElements.speed.textContent = `${Math.round(gameState.speed)}km/h`;
            DOMElements.compassFace.style.transform = `rotate(${ -map.getBearing() }deg)`;
        }

    </script>
</body>
</html>

